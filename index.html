<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redefining Intelligence App - Redefining Intelligence</title>
    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Poppins Font Integration -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f0f6fd 0%, #9daaec 100%);
            min-height: 100vh;
            color: #3e3a44;
            overflow-x: hidden;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .glass {
            background: rgba(240, 246, 253, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(111, 154, 76, 0.2);
            box-shadow: 0 8px 32px rgba(71, 72, 95, 0.15);
        }

        .header {
            text-align: center;
            padding: 40px 20px;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.9);
        }

        .header h1 {
            font-size: 2.5em;
            color: #47485f;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: none;
        }

        .header p {
            color: #6f9a4c;
            font-size: 1.1em;
            font-style: italic;
            font-weight: 400;
        }

        .search-section {
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
        }

        .search-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .species-input {
            padding: 15px;
            font-size: 16px;
            border: 2px solid #9daaec;
            border-radius: 12px;
            background: #f0f6fd;
            color: #3e3a44;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
        }

        .species-input:focus {
            outline: none;
            border-color: #6f9a4c;
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(111, 154, 76, 0.2);
        }

        .options-section {
            margin: 20px 0;
            text-align: left;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 15px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #47485f;
            font-weight: 500;
        }

        .checkbox-item input[type="checkbox"] {
            transform: scale(1.2);
            accent-color: #6f9a4c;
        }

        .research-btn {
            background: linear-gradient(135deg, #6f9a4c, #4e6440);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(111, 154, 76, 0.3);
            margin: 20px 10px;
        }

        .research-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(111, 154, 76, 0.4);
            background: linear-gradient(135deg, #4e6440, #6f9a4c);
        }

        .research-btn:disabled {
            background: #9daaec;
            cursor: not-allowed;
            transform: none;
        }

        .bridge-btn {
            background: linear-gradient(135deg, #634e87, #9daaec);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 78, 135, 0.3);
            margin: 20px 10px;
            text-decoration: none;
            display: inline-block;
        }

        .bridge-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(99, 78, 135, 0.4);
            background: linear-gradient(135deg, #9daaec, #634e87);
        }

        .results-container {
            padding: 30px;
            margin: 20px 0;
            position: relative;
            background: rgba(255, 255, 255, 0.95);
        }

        .species-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .species-header h2 {
            font-size: 2.2em;
            color: #47485f;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .research-type {
            display: inline-block;
            background: linear-gradient(135deg, #e7c64d, #f9ed65);
            color: #3e3a44;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .wisdom-insight {
            text-align: center;
            padding: 25px;
            margin: 25px 0;
            background: linear-gradient(135deg, rgba(231, 198, 77, 0.15), rgba(249, 237, 101, 0.15));
            border-radius: 15px;
            border-left: 5px solid #e7c64d;
            border: 1px solid rgba(231, 198, 77, 0.3);
        }

        .wisdom-insight h3 {
            color: #47485f;
            margin-bottom: 15px;
            font-size: 1.3em;
            font-weight: 600;
        }

        .wisdom-insight p {
            font-size: 1.1em;
            line-height: 1.7;
            color: #3e3a44;
            font-style: italic;
            font-weight: 400;
        }

        .intelligence-framework {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .framework-section {
            padding: 25px;
            border-radius: 15px;
            position: relative;
            border: 1px solid rgba(111, 154, 76, 0.2);
        }

        .perceive-section {
            background: linear-gradient(135deg, rgba(111, 154, 76, 0.1), rgba(78, 100, 64, 0.1));
            border-left: 5px solid #6f9a4c;
        }

        .relate-section {
            background: linear-gradient(135deg, rgba(157, 170, 236, 0.1), rgba(99, 78, 135, 0.1));
            border-left: 5px solid #9daaec;
        }

        .apply-section {
            background: linear-gradient(135deg, rgba(71, 72, 95, 0.1), rgba(62, 58, 68, 0.1));
            border-left: 5px solid #47485f;
        }

        .framework-section h3 {
            font-size: 1.4em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #47485f;
            font-weight: 600;
        }

        .framework-badge {
            background: linear-gradient(135deg, #6f9a4c, #4e6440);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .framework-section p {
            line-height: 1.7;
            margin-bottom: 15px;
            color: #3e3a44;
            font-weight: 400;
        }

        .framework-details {
            list-style: none;
            padding: 0;
        }

        .framework-details li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(111, 154, 76, 0.2);
            position: relative;
            padding-left: 20px;
            color: #3e3a44;
            font-weight: 400;
        }

        .framework-details li:before {
            content: "•";
            position: absolute;
            left: 0;
            color: #6f9a4c;
            font-weight: bold;
        }

        .comparative-section {
            margin: 40px 0;
            padding: 30px;
            background: linear-gradient(135deg, rgba(71, 72, 95, 0.08), rgba(99, 78, 135, 0.08));
            border-radius: 20px;
            border-left: 5px solid #634e87;
            border: 1px solid rgba(99, 78, 135, 0.2);
        }

        .comparative-section h2 {
            color: #47485f;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
            font-weight: 700;
        }

        .shared-patterns, .unique-expressions {
            margin: 25px 0;
            padding: 20px;
            background: rgba(240, 246, 253, 0.7);
            border-radius: 15px;
            border: 1px solid rgba(157, 170, 236, 0.3);
        }

        .shared-patterns h3, .unique-expressions h3 {
            color: #47485f;
            margin-bottom: 15px;
            font-size: 1.3em;
            font-weight: 600;
        }

        .shared-patterns p, .unique-expressions p {
            color: #3e3a44;
            margin-bottom: 15px;
            line-height: 1.7;
        }

        .pattern-list {
            color: #3e3a44;
            font-weight: 400;
        }

        .species-comparison {
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            border: 1px solid rgba(111, 154, 76, 0.2);
        }

        .species-comparison h4 {
            color: #6f9a4c;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .species-comparison div {
            color: #3e3a44;
            font-size: 0.9em;
            line-height: 1.5;
            margin-bottom: 5px;
        }

        .collective-wisdom {
            text-align: center;
            padding: 25px;
            margin: 25px 0;
            background: linear-gradient(135deg, rgba(111, 154, 76, 0.1), rgba(78, 100, 64, 0.1));
            border-radius: 15px;
            border-left: 5px solid #6f9a4c;
            border: 1px solid rgba(111, 154, 76, 0.3);
        }

        .collective-wisdom h3 {
            color: #47485f;
            margin-bottom: 15px;
            font-size: 1.3em;
            font-weight: 600;
        }

        .collective-wisdom p {
            color: #3e3a44;
            font-size: 1.1em;
            line-height: 1.7;
            font-style: italic;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .action-btn {
            flex: 1;
            min-width: 200px;
            padding: 15px 25px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .breakdown-btn {
            background: linear-gradient(135deg, #47485f, #3e3a44);
        }

        .contribute-btn {
            background: linear-gradient(135deg, #e7c64d, #f9ed65);
            color: #3e3a44;
        }

        .research-another-btn {
            background: linear-gradient(135deg, #9daaec, #634e87);
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(71, 72, 95, 0.2);
        }

        .loading-enhanced {
            text-align: center;
            padding: 60px 20px;
            margin: 20px 0;
        }

        .research-animation {
            font-size: 64px;
            animation: research-pulse 2s infinite;
            margin-bottom: 20px;
        }

        @keyframes research-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .usage-stats {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(71, 72, 95, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 12px;
            z-index: 100;
            font-family: 'Poppins', sans-serif;
        }

        .constellation-container {
            height: 400px;
            margin: 30px 0;
            background: rgba(71, 72, 95, 0.1);
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(71, 72, 95, 0.2);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(71, 72, 95, 0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: rgba(240, 246, 253, 0.98);
            margin: 3% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid rgba(111, 154, 76, 0.3);
        }

        .form-group {
            margin: 20px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #47485f;
            font-family: 'Poppins', sans-serif;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #9daaec;
            border-radius: 10px;
            font-size: 14px;
            background: #f0f6fd;
            font-family: 'Poppins', sans-serif;
            color: #3e3a44;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #6f9a4c;
            background: white;
        }

        /* Enhanced dimension styling */
        .enhanced-dimension {
            background: linear-gradient(135deg, rgba(111, 154, 76, 0.08), rgba(231, 198, 77, 0.08));
            border-left: 4px solid #6f9a4c;
            border: 1px solid rgba(111, 154, 76, 0.2);
        }

        .temporal-dimension {
            background: linear-gradient(135deg, rgba(231, 198, 77, 0.08), rgba(249, 237, 101, 0.08));
            border-left: 4px solid #e7c64d;
            border: 1px solid rgba(231, 198, 77, 0.2);
        }

        .energetic-dimension {
            background: linear-gradient(135deg, rgba(78, 100, 64, 0.08), rgba(111, 154, 76, 0.08));
            border-left: 4px solid #4e6440;
            border: 1px solid rgba(78, 100, 64, 0.2);
        }

        .collective-dimension {
            background: linear-gradient(135deg, rgba(157, 170, 236, 0.08), rgba(99, 78, 135, 0.08));
            border-left: 4px solid #9daaec;
            border: 1px solid rgba(157, 170, 236, 0.2);
        }

        .adaptive-dimension {
            background: linear-gradient(135deg, rgba(99, 78, 135, 0.08), rgba(71, 72, 95, 0.08));
            border-left: 4px solid #634e87;
            border: 1px solid rgba(99, 78, 135, 0.2);
        }

        .fade-in {
            animation: fadeIn 0.6s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .search-grid {
                grid-template-columns: 1fr;
            }

            .intelligence-framework {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-btn {
                min-width: auto;
            }

            .research-btn, .bridge-btn {
                display: block;
                margin: 10px 0;
                width: 100%;
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f0f6fd;
        }

        ::-webkit-scrollbar-thumb {
            background: #9daaec;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6f9a4c;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header glass">
            <h1>Species Intelligence Research Agent</h1>
            <p>Redefining Intelligence Through the Perceive • Relate • Apply Framework</p>
        </header>

        <section class="search-section glass">
            <h2 style="color: #47485f; margin-bottom: 20px; font-weight: 600;">Explore Species Intelligence</h2>
            
            <div class="search-grid">
                <input type="text" class="species-input" id="species1" placeholder="Enter first species (e.g., dolphins)" />
                <input type="text" class="species-input" id="species2" placeholder="Enter second species (optional)" />
                <input type="text" class="species-input" id="species3" placeholder="Enter third species (optional)" />
                <input type="text" class="species-input" id="species4" placeholder="Enter fourth species (optional)" />
                <input type="text" class="species-input" id="species5" placeholder="Enter fifth species (optional)" />
            </div>

            <div class="options-section">
                <h3 style="color: #47485f; margin-bottom: 15px; font-weight: 600;">Enhanced Research Options</h3>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="includeIndigenous" />
                        <label for="includeIndigenous">Include Indigenous Knowledge</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="includeBiomimicry" />
                        <label for="includeBiomimicry">Include Biomimicry Applications</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="includeHuman" />
                        <label for="includeHuman">Compare with Human Intelligence</label>
                    </div>
                </div>
            </div>

            <button class="research-btn" onclick="conductResearch()">
                🔬 Reveal Intelligence
            </button>
            
            <button class="research-btn contribute-btn" onclick="showContributionForm()" style="background: linear-gradient(135deg, #e7c64d, #f9ed65); color: #3e3a44; margin-left: 10px;">
                🤝 Contribute Knowledge
            </button>

            <a href="https://ai-consciousness-bridge.netlify.app/" class="bridge-btn" target="_blank">
                🌉 Explore AI Consciousness Bridge
            </a>

            <div style="margin-top: 20px;">
                <div id="usageDisplay" style="color: #47485f; font-size: 14px; font-weight: 500;"></div>
            </div>
        </section>

        <div id="constellationContainer" class="constellation-container glass" style="display: none;">
            <canvas id="constellationCanvas" width="100%" height="400"></canvas>
        </div>

        <div id="results"></div>

        <div class="usage-stats" id="usageStats"></div>
        
        <!-- Footer Section -->
        <footer style="text-align: center; padding: 30px; margin-top: 50px; background: rgba(71, 72, 95, 0.1); border-radius: 15px; color: #47485f; font-size: 0.9em; max-width: 1200px; margin-left: auto; margin-right: auto;">
            <p><strong>Species Intelligence Research Agent</strong> • Revolutionary consciousness research platform</p>
            <p style="margin-top: 10px;">Part of the Intuitive Learning Foundation consciousness research initiative</p>
            <p style="margin-top: 15px; font-size: 0.9em;">
                <a href="README.md" target="_blank" style="color: #6f9a4c; text-decoration: none; font-weight: 500; border-bottom: 1px solid transparent; transition: border-color 0.3s ease;" onmouseover="this.style.borderColor='#6f9a4c'" onmouseout="this.style.borderColor='transparent'">
                    📚 About This Research Platform
                </a>
            </p>
            <p style="margin-top: 10px; font-size: 0.8em;">
                Visit: <a href="https://intuitivelearningfoundation.org" style="color: #6f9a4c;">intuitivelearningfoundation.org</a> • 
                <a href="https://generateharmony.com" style="color: #6f9a4c;">generateharmony.com</a> • 
                <a href="https://kerrilake.com" style="color: #6f9a4c;">kerrilake.com</a>
            </p>
        </footer>
    </div>

    <!-- Community Contribution Modal -->
    <div id="contributionModal" class="modal">
        <div class="modal-content glass">
            <span style="position: absolute; right: 20px; top: 15px; font-size: 28px; font-weight: bold; cursor: pointer; color: #47485f;" onclick="closeContributionModal()">&times;</span>
            <h3 style="color: #47485f; font-weight: 600;">Contribute Species Intelligence Knowledge</h3>
            <p style="color: #3e3a44;">Share your research, observations, or insights about species intelligence</p>
            
            <div id="contributionForm">
                <div class="form-group">
                    <label for="contributorName">Your Name/Organization *:</label>
                    <input type="text" id="contributorName" required>
                </div>
                
                <div class="form-group">
                    <label for="contributorEmail">Email (for verification) *:</label>
                    <input type="email" id="contributorEmail" required>
                </div>
                
                <div class="form-group">
                    <label for="contributorCredentials">Credentials/Background:</label>
                    <input type="text" id="contributorCredentials" placeholder="PhD in Biology, Indigenous Elder, Professional Animal Communicator, etc.">
                </div>
                
                <div class="form-group">
                    <label for="speciesName">Species Name *:</label>
                    <input type="text" id="speciesName" required>
                </div>
                
                <div class="form-group">
                    <label for="wisdomInsight">Key Wisdom Insight *:</label>
                    <textarea id="wisdomInsight" rows="3" required 
                            placeholder="What profound insight about this species' intelligence should people know?"></textarea>
                </div>
                
                <div style="background: rgba(111, 154, 76, 0.1); padding: 20px; border-radius: 12px; margin: 20px 0; border: 1px solid rgba(111, 154, 76, 0.2);">
                    <h4 style="color: #6f9a4c; margin-bottom: 12px; font-weight: 600;">PERCEIVE - How they perceive their world:</h4>
                    <textarea id="perceiveData" rows="4" required
                            placeholder="Describe their sensory capabilities, environmental awareness, unique perceptual gifts..."></textarea>
                </div>
                
                <div style="background: rgba(111, 154, 76, 0.1); padding: 20px; border-radius: 12px; margin: 20px 0; border: 1px solid rgba(111, 154, 76, 0.2);">
                    <h4 style="color: #6f9a4c; margin-bottom: 12px; font-weight: 600;">RELATE - How they relate to their world:</h4>
                    <textarea id="relateData" rows="4" required
                            placeholder="Social structures, communication, ecological relationships, cultural significance..."></textarea>
                </div>
                
                <div style="background: rgba(111, 154, 76, 0.1); padding: 20px; border-radius: 12px; margin: 20px 0; border: 1px solid rgba(111, 154, 76, 0.2);">
                    <h4 style="color: #6f9a4c; margin-bottom: 12px; font-weight: 600;">APPLY - How they apply their intelligence:</h4>
                    <textarea id="applyData" rows="4" required
                            placeholder="Problem-solving, tool use, learning, ecosystem contributions..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="humanLearnings">What humans can learn from this species *:</label>
                    <textarea id="humanLearnings" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="conservationWisdom">Conservation intelligence insights *:</label>
                    <textarea id="conservationWisdom" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="sources">Sources/References (required) *:</label>
                    <textarea id="sources" rows="4" required
                            placeholder="List your sources: research papers, traditional knowledge, personal observation, etc. At least 2 sources required."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="experienceType">Type of contribution *:</label>
                    <select id="experienceType" required>
                        <option value="">Select type</option>
                        <option value="scientific">Scientific Research</option>
                        <option value="indigenous">Indigenous/Traditional Knowledge</option>
                        <option value="observation">Field Observation</option>
                        <option value="interspecies">Interspecies Communication</option>
                        <option value="biomimicry">Biomimicry Application</option>
                        <option value="conservation">Conservation Experience</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="accuracy" required>
                        <label for="accuracy">I verify that this information is accurate to the best of my knowledge *</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="permission" required>
                        <label for="permission">I give permission for this contribution to be used in the Species Intelligence Research database *</label>
                    </div>
                </div>
                
                <button onclick="submitContribution()" style="background: linear-gradient(135deg, #6f9a4c, #4e6440); color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-size: 16px; font-weight: 600; width: 100%; margin-top: 20px; font-family: 'Poppins', sans-serif;">Submit Contribution</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            DAILY_SEARCH_LIMIT: 6,
            MONTHLY_BUDGET: 100,
            COST_PER_SEARCH: 0.50,
            EMAIL_THRESHOLD: 80
        };

        // Global state with intelligence vectors
        let currentSpeciesData = [];
        let researchHistory = JSON.parse(localStorage.getItem('researchHistory') || '[]');
        let dailyUsage = JSON.parse(localStorage.getItem('dailyUsage') || '{}');
        let monthlySpend = parseFloat(localStorage.getItem('monthlySpend') || '0');
        let intelligenceVectors = JSON.parse(localStorage.getItem('intelligenceVectors') || '{}');
        let constellationData = JSON.parse(localStorage.getItem('constellationData') || '[]');

        // MAIN RESEARCH FUNCTION
        async function conductResearch() {
            const speciesInputs = [
                document.getElementById('species1').value.trim(),
                document.getElementById('species2').value.trim(),
                document.getElementById('species3').value.trim(),
                document.getElementById('species4').value.trim(),
                document.getElementById('species5').value.trim()
            ].filter(species => species.length > 0);

            if (speciesInputs.length === 0) {
                alert('Please enter at least one species name');
                return;
            }

            const today = new Date().toDateString();
            if (!dailyUsage[today]) dailyUsage[today] = 0;

            // Cost limiting enforcement
            if (dailyUsage[today] >= CONFIG.DAILY_SEARCH_LIMIT) {
                alert(`Daily search limit reached (${CONFIG.DAILY_SEARCH_LIMIT} searches). Please try again tomorrow to stay within budget limits.`);
                return;
            }

            const projectedCost = monthlySpend + (CONFIG.COST_PER_SEARCH * speciesInputs.length);
            if (projectedCost > CONFIG.MONTHLY_BUDGET) {
                alert(`Monthly budget limit would be exceeded (${projectedCost.toFixed(2)} > ${CONFIG.MONTHLY_BUDGET}). Please wait until next month or reduce the number of species.`);
                return;
            }

            if (projectedCost > (CONFIG.MONTHLY_BUDGET * 0.8) && monthlySpend <= (CONFIG.MONTHLY_BUDGET * 0.8)) {
                if (!confirm(`Warning: This search will use ${((projectedCost/CONFIG.MONTHLY_BUDGET)*100).toFixed(1)}% of your monthly budget. Continue?`)) {
                    return;
                }
            }

            const options = {
                includeIndigenous: document.getElementById('includeIndigenous').checked,
                includeBiomimicry: document.getElementById('includeBiomimicry').checked,
                includeHuman: document.getElementById('includeHuman').checked
            };

            if (options.includeHuman) {
                speciesInputs.push('Human');
            }

            const resultsDiv = document.getElementById('results');
            
            try {
                // Show loading
                resultsDiv.innerHTML = `
                    <div class="results-container glass fade-in">
                        <div class="loading-enhanced">
                            <div class="research-animation">🧬</div>
                            <h3 style="color: #47485f;">Conducting Deep Species Intelligence Research</h3>
                            <p style="color: #3e3a44;">Enhanced Claude AI analysis with temporal, energetic, collective, and adaptive intelligence dimensions</p>
                            <p style="color: #6f9a4c; font-size: 14px; margin-top: 10px;">This comprehensive research may take 15-20 seconds per species...</p>
                        </div>
                    </div>
                `;

                // Call AI API for each species
                const researchResults = [];
                for (let i = 0; i < speciesInputs.length; i++) {
                    const species = speciesInputs[i];
                    
                    // Update loading message
                    resultsDiv.innerHTML = `
                        <div class="results-container glass fade-in">
                            <div class="loading-enhanced">
                                <div class="research-animation">🧬</div>
                                <h3 style="color: #47485f;">Researching ${species}...</h3>
                                <p style="color: #3e3a44;">Species ${i + 1} of ${speciesInputs.length} • Enhanced Claude AI</p>
                                <div style="background: rgba(111, 154, 76, 0.2); padding: 10px; border-radius: 10px; margin: 10px 0;">
                                    <div style="width: ${(i/speciesInputs.length)*100}%; height: 4px; background: #6f9a4c; border-radius: 2px;"></div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    const result = await callAnthropicAPI(species, options);
                    researchResults.push(result);
                }

                // Update usage tracking
                dailyUsage[today]++;
                monthlySpend += CONFIG.COST_PER_SEARCH * speciesInputs.length;
                localStorage.setItem('dailyUsage', JSON.stringify(dailyUsage));
                localStorage.setItem('monthlySpend', monthlySpend.toString());

                // Store in research history
                const searchRecord = {
                    species: speciesInputs,
                    timestamp: new Date().toISOString(),
                    options: options,
                    results: researchResults
                };
                researchHistory.push(searchRecord);
                localStorage.setItem('researchHistory', JSON.stringify(researchHistory));

                // Display results
                displayEnhancedResults(researchResults);
                updateUsageDisplay();
                
                // Update Intelligence Mapping System
                updateIntelligenceMapping(researchResults);
                
            } catch (error) {
                console.error('Research failed:', error);
                resultsDiv.innerHTML = `
                    <div class="results-container glass fade-in">
                        <div style="text-align: center; padding: 40px;">
                            <h3 style="color: #47485f;">Research Temporarily Unavailable</h3>
                            <p style="color: #3e3a44;">Error: ${error.message}</p>
                            <button onclick="conductResearch()" style="background: linear-gradient(135deg, #6f9a4c, #4e6440); color: white; border: none; padding: 12px 25px; border-radius: 20px; cursor: pointer; margin-top: 15px; font-family: 'Poppins', sans-serif;">Try Again</button>
                        </div>
                    </div>
                `;
            }
        }

        // UTILITY FUNCTIONS
        function showContributionForm() {
            document.getElementById('contributionModal').style.display = 'block';
        }

        function closeContributionModal() {
            document.getElementById('contributionModal').style.display = 'none';
        }

        function resetSearch() {
            document.getElementById('species1').value = '';
            document.getElementById('species2').value = '';
            document.getElementById('species3').value = '';
            document.getElementById('species4').value = '';
            document.getElementById('species5').value = '';
            document.getElementById('includeIndigenous').checked = false;
            document.getElementById('includeBiomimicry').checked = false;
            document.getElementById('includeHuman').checked = false;
            document.getElementById('results').innerHTML = '';
            document.getElementById('constellationContainer').style.display = 'none';
            document.getElementById('species1').focus();
        }

        // Intelligence Vector Generation System
        function analyzeTextComplexity(text) {
            if (!text || typeof text !== 'string') return 0.5;
            
            const words = text.trim().split(/\s+/);
            const wordCount = words.length;
            const uniqueWords = new Set(words.map(w => w.toLowerCase())).size;
            const avgWordLength = words.join('').length / wordCount;
            const sentenceCount = text.split(/[.!?]+/).filter(s => s.trim().length > 0).length;
            
            // Normalize to 0-1 scale
            const complexityScore = Math.min(1, (
                (wordCount / 100) * 0.3 +
                (uniqueWords / wordCount) * 0.3 +
                (avgWordLength / 10) * 0.2 +
                (sentenceCount / 10) * 0.2
            ));
            
            return Math.max(0.1, complexityScore);
        }

        function calculateOverallComplexity(speciesData) {
            const dimensions = [
                speciesData.perceive?.summary || '',
                speciesData.relate?.summary || '',
                speciesData.apply?.summary || '',
                speciesData.temporalIntelligence || '',
                speciesData.energeticIntelligence || '',
                speciesData.collectiveWisdom || '',
                speciesData.adaptiveStrategies || ''
            ];
            
            const avgComplexity = dimensions.reduce((sum, text) => 
                sum + analyzeTextComplexity(text), 0) / dimensions.length;
            
            return avgComplexity;
        }

        function calculateVectorSimilarity(vector1, vector2) {
            const dimensions = ['perceive', 'relate', 'apply', 'temporal', 'energetic', 'collective', 'adaptive'];
            let similarity = 0;
            
            dimensions.forEach(dim => {
                const diff = Math.abs((vector1[dim] || 0.5) - (vector2[dim] || 0.5));
                similarity += (1 - diff) / dimensions.length;
            });
            
            return similarity;
        }

        function calculateUniquenessForVector(currentVector) {
            let uniquenessScore = 1.0;
            
            Object.values(intelligenceVectors).forEach(existingVector => {
                if (existingVector.species !== currentVector.species) {
                    const similarity = calculateVectorSimilarity(currentVector, existingVector);
                    uniquenessScore = Math.min(uniquenessScore, 1 - similarity);
                }
            });
            
            return Math.max(0.1, uniquenessScore);
        }

        function generateIntelligenceVector(speciesData) {
            const vector = {
                species: speciesData.species,
                timestamp: new Date().toISOString(),
                
                // Core P/R/A Dimensions (0-1 scale)
                perceive: analyzeTextComplexity(speciesData.perceive?.summary || ''),
                relate: analyzeTextComplexity(speciesData.relate?.summary || ''),
                apply: analyzeTextComplexity(speciesData.apply?.summary || ''),
                
                // Enhanced Dimensions (0-1 scale)
                temporal: analyzeTextComplexity(speciesData.temporalIntelligence || ''),
                energetic: analyzeTextComplexity(speciesData.energeticIntelligence || ''),
                collective: analyzeTextComplexity(speciesData.collectiveWisdom || ''),
                adaptive: analyzeTextComplexity(speciesData.adaptiveStrategies || ''),
                
                // Meta Intelligence Attributes
                complexity: calculateOverallComplexity(speciesData),
                humanRelevance: analyzeTextComplexity(speciesData.humanLearnings || ''),
                conservationUrgency: analyzeTextComplexity(speciesData.conservationWisdom || ''),
                
                // Research Quality Indicators
                researchBacked: speciesData.researchBacked || false,
                sourceCount: speciesData.sources?.length || 0
            };
            
            // Calculate uniqueness after vector creation
            vector.uniqueness = calculateUniquenessForVector(vector);
            
            return vector;
        }

        function generateConstellationPosition(vector) {
            // Use P/R/A as primary axes, enhanced dimensions for fine positioning
            const x = (vector.perceive - 0.5) * 200 + (vector.temporal - 0.5) * 50;
            const y = (vector.relate - 0.5) * 200 + (vector.collective - 0.5) * 50;
            const z = (vector.apply - 0.5) * 200 + (vector.adaptive - 0.5) * 50;
            
            return { x, y, z };
        }

        function updateIntelligenceMapping(speciesDataArray) {
            speciesDataArray.forEach(speciesData => {
                // Generate intelligence vector
                const vector = generateIntelligenceVector(speciesData);
                intelligenceVectors[speciesData.species] = vector;
                
                // Generate 3D constellation position
                const position = generateConstellationPosition(vector);
                
                // Update constellation data
                const existingIndex = constellationData.findIndex(item => item.species === speciesData.species);
                const constellationPoint = {
                    species: speciesData.species,
                    position: position,
                    vector: vector,
                    timestamp: new Date().toISOString(),
                    researchBacked: speciesData.researchBacked || false
                };
                
                if (existingIndex >= 0) {
                    constellationData[existingIndex] = constellationPoint;
                } else {
                    constellationData.push(constellationPoint);
                }
            });
            
            // Save to localStorage
            localStorage.setItem('intelligenceVectors', JSON.stringify(intelligenceVectors));
            localStorage.setItem('constellationData', JSON.stringify(constellationData));
            
            // Update constellation visualization
            updateAdvancedConstellation();
        }

        function updateAdvancedConstellation() {
            const container = document.getElementById('constellationContainer');
            const canvas = document.getElementById('constellationCanvas');
            
            if (!container || !canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            if (constellationData.length === 0) return;
            
            container.style.display = 'block';
            canvas.width = container.offsetWidth;
            canvas.height = 400;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // Draw constellation background
            ctx.fillStyle = 'rgba(71, 72, 95, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw intelligence dimensions axes
            ctx.strokeStyle = 'rgba(111, 154, 76, 0.3)';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            
            // X-axis (Perceive)
            ctx.beginPath();
            ctx.moveTo(50, centerY);
            ctx.lineTo(canvas.width - 50, centerY);
            ctx.stroke();
            
            // Y-axis (Relate)  
            ctx.beginPath();
            ctx.moveTo(centerX, 50);
            ctx.lineTo(centerX, canvas.height - 50);
            ctx.stroke();
            
            ctx.setLineDash([]);
            
            // Draw species connections (if multiple species)
            if (constellationData.length > 1) {
                constellationData.forEach((species1, i) => {
                    constellationData.slice(i + 1).forEach(species2 => {
                        const similarity = calculateVectorSimilarity(species1.vector, species2.vector);
                        
                        if (similarity > 0.7) { // Only draw strong connections
                            const x1 = centerX + species1.position.x * 0.8;
                            const y1 = centerY + species1.position.y * 0.8;
                            const x2 = centerX + species2.position.x * 0.8;
                            const y2 = centerY + species2.position.y * 0.8;
                            
                            ctx.beginPath();
                            ctx.moveTo(x1, y1);
                            ctx.lineTo(x2, y2);
                            ctx.strokeStyle = `rgba(231, 198, 77, ${similarity * 0.5})`;
                            ctx.lineWidth = similarity * 3;
                            ctx.stroke();
                        }
                    });
                });
            }
            
            // Draw species nodes
            constellationData.forEach(speciesPoint => {
                const x = centerX + speciesPoint.position.x * 0.8;
                const y = centerY + speciesPoint.position.y * 0.8;
                const complexity = speciesPoint.vector.complexity;
                const radius = 5 + complexity * 10;
                
                // Node circle
                ctx.beginPath();
                ctx.arc(x, y, radius, 0, 2 * Math.PI);
                ctx.fillStyle = speciesPoint.researchBacked ? 
                    `rgba(111, 154, 76, ${0.7 + complexity * 0.3})` : 
                    `rgba(157, 170, 236, ${0.5 + complexity * 0.2})`;
                ctx.fill();
                
                // Node border
                ctx.strokeStyle = speciesPoint.researchBacked ? '#6f9a4c' : '#9daaec';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Species name
                ctx.fillStyle = '#47485f';
                ctx.font = '10px Poppins';
                ctx.textAlign = 'center';
                ctx.fillText(speciesPoint.species, x, y + radius + 15);
                
                // Intelligence indicators
                if (speciesPoint.researchBacked) {
                    ctx.fillText('✨', x, y + radius + 25);
                }
            });
            
            // Draw dimension labels
            ctx.fillStyle = '#47485f';
            ctx.font = '12px Poppins';
            ctx.textAlign = 'left';
            ctx.fillText('← Perceive', 60, centerY - 10);
            ctx.textAlign = 'right';
            ctx.fillText('Perceive →', canvas.width - 60, centerY - 10);
            ctx.textAlign = 'center';
            ctx.fillText('↑ Relate', centerX + 10, 70);
            ctx.fillText('Relate ↓', centerX + 10, canvas.height - 60);
            
            // Constellation statistics
            ctx.fillStyle = '#6f9a4c';
            ctx.font = '14px Poppins';
            ctx.textAlign = 'center';
            ctx.fillText(`Species Intelligence Constellation: ${constellationData.length} Species Mapped`, centerX, 30);
        }

        function showIntelligenceMapping() {
            if (Object.keys(intelligenceVectors).length === 0) {
                alert('No species intelligence data available yet. Please conduct some research first to build the constellation!');
                return;
            }
            
            // Show detailed intelligence mapping analysis
            const mappingAnalysis = generateMappingAnalysis();
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="results-container glass fade-in">
                    <div class="species-header">
                        <h2>🌌 Species Intelligence Constellation Map</h2>
                        <div class="research-type">Intelligence Vector Analysis • ${Object.keys(intelligenceVectors).length} Species Mapped</div>
                    </div>
                    
                    <div class="wisdom-insight">
                        <h3>🧠 Consciousness Topology</h3>
                        <p>This constellation maps species intelligence across the Perceive/Relate/Apply framework, revealing hidden patterns and connections between different forms of consciousness. Each species becomes a node in a multidimensional intelligence space.</p>
                    </div>
                    
                    ${mappingAnalysis}
                    
                    <div class="action-buttons">
                        <button class="action-btn research-another-btn" onclick="resetSearch()">
                            🔍 Research More Species
                        </button>
                        <button class="action-btn breakdown-btn" onclick="exportConstellationData()">
                            📊 Export Constellation Data
                        </button>
                    </div>
                </div>
            `;
            
            // Force update the constellation visualization
            setTimeout(() => updateAdvancedConstellation(), 100);
        }

        function generateMappingAnalysis() {
            const vectors = Object.values(intelligenceVectors);
            if (vectors.length === 0) return '';
            
            // Calculate intelligence patterns
            const avgPerceive = vectors.reduce((sum, v) => sum + v.perceive, 0) / vectors.length;
            const avgRelate = vectors.reduce((sum, v) => sum + v.relate, 0) / vectors.length;
            const avgApply = vectors.reduce((sum, v) => sum + v.apply, 0) / vectors.length;
            
            // Find clusters
            const highCollective = vectors.filter(v => v.collective > 0.7).map(v => v.species);
            const highTemporal = vectors.filter(v => v.temporal > 0.7).map(v => v.species);
            const highEnergetic = vectors.filter(v => v.energetic > 0.7).map(v => v.species);
            
            // Find most unique species
            const mostUnique = vectors.sort((a, b) => b.uniqueness - a.uniqueness)[0];
            
            return `
                <div class="intelligence-framework">
                    <div class="framework-section perceive-section">
                        <h3><span class="framework-badge">PATTERNS</span> Intelligence Clusters Discovered</h3>
                        <div><strong>Collective Intelligence Hub:</strong> ${highCollective.join(', ') || 'None yet discovered'}</div>
                        <div><strong>Temporal Masters:</strong> ${highTemporal.join(', ') || 'None yet discovered'}</div>
                        <div><strong>Energetic Sensitives:</strong> ${highEnergetic.join(', ') || 'None yet discovered'}</div>
                        <div style="margin-top: 10px;"><strong>Most Unique Intelligence:</strong> ${mostUnique?.species || 'Calculating...'} (${(mostUnique?.uniqueness * 100).toFixed(1)}% unique)</div>
                    </div>
                    
                    <div class="framework-section relate-section">
                        <h3><span class="framework-badge">AVERAGES</span> Consciousness Baseline</h3>
                        <div><strong>Average Perceive Intelligence:</strong> ${(avgPerceive * 100).toFixed(1)}%</div>
                        <div><strong>Average Relate Intelligence:</strong> ${(avgRelate * 100).toFixed(1)}%</div>
                        <div><strong>Average Apply Intelligence:</strong> ${(avgApply * 100).toFixed(1)}%</div>
                        <div style="margin-top: 10px;"><strong>Research Quality:</strong> ${vectors.filter(v => v.researchBacked).length}/${vectors.length} AI-enhanced</div>
                    </div>
                    
                    <div class="framework-section apply-section">
                        <h3><span class="framework-badge">INSIGHTS</span> Emerging Patterns</h3>
                        <div><strong>Consciousness Diversity:</strong> ${vectors.length} unique intelligence signatures mapped</div>
                        <div><strong>Vector Complexity:</strong> ${(vectors.reduce((sum, v) => sum + v.complexity, 0) / vectors.length * 100).toFixed(1)}% average</div>
                        <div><strong>Human Relevance:</strong> ${(vectors.reduce((sum, v) => sum + v.humanRelevance, 0) / vectors.length * 100).toFixed(1)}% learning potential</div>
                        <div style="margin-top: 10px;"><em>Pattern recognition improving with each species added...</em></div>
                    </div>
                </div>
            `;
        }

        function exportConstellationData() {
            const exportData = {
                metadata: {
                    generatedAt: new Date().toISOString(),
                    speciesCount: Object.keys(intelligenceVectors).length,
                    framework: "Perceive/Relate/Apply Intelligence Mapping",
                    version: "1.0-enhanced"
                },
                intelligenceVectors: intelligenceVectors,
                constellationData: constellationData,
                patternAnalysis: generateMappingAnalysis()
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `species-intelligence-constellation-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            
            alert('🌌 Species Intelligence Constellation data exported! This JSON file contains all intelligence vectors, 3D positions, and pattern analysis.');
        }

        // SIMPLIFIED TEST VERSION - Replace your callAnthropicAPI function with this minimal version
async function callAnthropicAPI(speciesName, options) {
    console.log('🔍 Testing API call for:', speciesName);
    
    try {
        // Create a very simple prompt for testing
        const simplePrompt = `Tell me about ${speciesName} intelligence in JSON format with these fields:
{
  "species": "${speciesName}",
  "wisdomInsight": "brief insight",
  "perceive": {"summary": "how they perceive", "details": ["detail1", "detail2"]},
  "relate": {"summary": "how they relate", "details": ["detail1", "detail2"]},
  "apply": {"summary": "how they apply intelligence", "details": ["detail1", "detail2"]},
  "humanLearnings": "what humans can learn",
  "conservationWisdom": "conservation insight",
  "sources": ["source1", "source2"]
}`;

        console.log('📤 Sending request to Netlify function...');
        
        const response = await fetch('/.netlify/functions/research-species', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                species: speciesName,
                prompt: simplePrompt,
                options: options
            })
        });

        console.log('📨 Response status:', response.status);

        if (!response.ok) {
            const errorText = await response.text();
            console.error('❌ Response error:', errorText);
            throw new Error(`API Error: ${response.status} - ${errorText}`);
        }

        const data = await response.json();
        console.log('✅ Response data:', data);
        
        if (data.success && data.response) {
            console.log('🎉 API call successful! Parsing response...');
            
            // Simple parsing - no complex validation
            let aiResponse;
            try {
                const cleanResponse = data.response.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
                aiResponse = JSON.parse(cleanResponse);
            } catch (parseError) {
                console.warn('Parse error, using simple fallback');
                aiResponse = {
                    species: speciesName,
                    wisdomInsight: "AI provided intelligence insights",
                    perceive: { summary: "Advanced perception", details: ["Sensory capabilities"] },
                    relate: { summary: "Social relationships", details: ["Communication"] },
                    apply: { summary: "Problem solving", details: ["Adaptation"] },
                    humanLearnings: "Valuable lessons for humans",
                    conservationWisdom: "Important for ecosystem",
                    sources: ["AI research"]
                };
            }
            
            // Add required fields for your existing code
            return {
                species: aiResponse.species || speciesName,
                wisdomInsight: aiResponse.wisdomInsight || "Intelligent species",
                perceive: aiResponse.perceive || { summary: "Advanced perception", details: [] },
                relate: aiResponse.relate || { summary: "Social intelligence", details: [] },
                apply: aiResponse.apply || { summary: "Problem solving", details: [] },
                humanLearnings: aiResponse.humanLearnings || "Lessons for humans",
                conservationWisdom: aiResponse.conservationWisdom || "Conservation importance",
                quantumAspects: "Quantum biology connections",
                temporalIntelligence: "Time perception abilities", 
                energeticIntelligence: "Energy sensitivity",
                collectiveWisdom: "Group intelligence",
                adaptiveStrategies: "Adaptation mechanisms",
                sources: aiResponse.sources || ["AI research"],
                researchBacked: true,
                timestamp: new Date().toISOString()
            };
            
        } else {
            throw new Error(data.error || 'API call failed - no success flag');
        }
        
    } catch (error) {
        console.error('🚨 Final error in callAnthropicAPI:', error);
        
        // Return simple fallback
        return {
            species: speciesName,
            wisdomInsight: `${speciesName} demonstrates remarkable intelligence.`,
            perceive: { summary: "Sophisticated sensory systems", details: ["Environmental awareness"] },
            relate: { summary: "Complex social relationships", details: ["Communication"] },
            apply: { summary: "Adaptive problem-solving", details: ["Learning"] },
            humanLearnings: "Valuable lessons for human understanding",
            conservationWisdom: "Important for ecosystem balance",
            quantumAspects: "Potential quantum processes",
            temporalIntelligence: "Time perception capabilities",
            energeticIntelligence: "Energy field sensitivity", 
            collectiveWisdom: "Group decision-making",
            adaptiveStrategies: "Environmental adaptation",
            sources: ["General research"],
            researchBacked: false,
            fallbackReason: `API Error: ${error.message}`,
            timestamp: new Date().toISOString()
        };
    }
}

// You'll also need this function to generate prompts for each species:
function generatePrompt(species, options) {
    let prompt = `Conduct a comprehensive intelligence analysis of ${species}. Provide detailed information about:
1. **Cognitive Intelligence**: Problem-solving abilities, learning capacity, memory systems
2. **Social Intelligence**: Communication methods, group dynamics, cooperation strategies  
3. **Adaptive Intelligence**: Environmental adaptation, behavioral flexibility, survival strategies
4. **Temporal Intelligence**: Time perception, planning abilities, learning from experience
5. **Sensory Intelligence**: Sensory capabilities, information processing, environmental awareness
Format the response with clear sections and specific examples. Include fascinating facts and recent research findings.`;
    
    if (options.includeIndigenous) {
        prompt += `\n\nAlso include traditional indigenous knowledge and cultural perspectives about this species.`;
    }
    
    if (options.includeBiomimicry) {
        prompt += `\n\nInclude biomimicry applications and how humans have learned from this species.`;
    }
    
    prompt += `\n\nProvide a comprehensive analysis that's both scientifically accurate and engaging to read.`;
    
    return prompt;
}

        function createResearchPrompt(speciesName, options) {
            const indigenousKnowledge = options.includeIndigenous ? `
- Indigenous wisdom and traditional ecological knowledge from various cultures
- Sacred relationships and ceremonial connections with this species
- Traditional uses and spiritual significance across different indigenous traditions` : '';

            const biomimicryApplications = options.includeBiomimicry ? `
- Current biomimicry applications inspired by this species
- Potential future technological innovations based on their capabilities
- Economic and environmental impact of species-inspired technologies` : '';

            return `You are a multidisciplinary species intelligence researcher specializing in consciousness studies and quantum biology. Research ${speciesName} through the revolutionary "Perceive/Relate/Apply" intelligence framework.

RESEARCH REQUIREMENTS:
1. PERCEIVE: How does ${speciesName} perceive their world?
   - Sensory capabilities and unique perceptual gifts
   - Environmental awareness and information processing
   - Quantum sensing abilities and field perception
   - Survival perception mechanisms

2. RELATE: How does ${speciesName} relate to their world?
   - Social structures and communication methods
   - Ecological relationships and symbiosis
   - Emotional and energetic connections
   - Cultural significance in human societies
   - Interspecies relationship patterns

3. APPLY: How does ${speciesName} apply their intelligence?
   - Problem-solving behaviors and adaptations
   - Tool use and environmental manipulation
   - Learning, memory, and knowledge transfer
   - Contributions to ecosystem health and balance

SOURCES TO CONSULT:
- Peer-reviewed biology, ecology, ethology, and neuroscience research
- Consciousness and quantum biology studies${indigenousKnowledge}${biomimicryApplications}
- Behavioral studies and cognitive research
- Conservation and environmental research

RESPONSE FORMAT:
Provide a JSON response with this exact structure:
{
  "species": "${speciesName}",
  "wisdomInsight": "One profound insight about this species' intelligence that could expand human consciousness (2-3 sentences)",
  "perceive": {
    "summary": "How they perceive their world (2-3 sentences)",
    "details": ["specific perceptual capability 1", "specific perceptual capability 2", "specific perceptual capability 3", "quantum/field perception aspect"]
  },
  "relate": {
    "summary": "How they relate to their world (2-3 sentences)", 
    "details": ["relationship aspect 1", "relationship aspect 2", "relationship aspect 3", "consciousness connection aspect"]
  },
  "apply": {
    "summary": "How they apply intelligence (2-3 sentences)",
    "details": ["application example 1", "application example 2", "application example 3", "ecosystem contribution"]
  },
  "humanLearnings": "What humans can learn from ${speciesName}'s intelligence for consciousness evolution",
  "conservationWisdom": "How their intelligence relates to conservation needs and ecosystem health",
  "quantumAspects": "Quantum biology and consciousness connections documented in research",
  "temporalIntelligence": "How this species perceives and works with time, seasonal cycles, and long-term patterns (4-5 sentences)",
  "energeticIntelligence": "Biofield interactions, electromagnetic sensitivity, energy optimization with documented cases (4-5 sentences)",
  "collectiveWisdom": "Group consciousness, collective decision-making, and distributed intelligence with specific behaviors (4-5 sentences)",
  "adaptiveStrategies": "Real-time adaptation mechanisms, crisis responses, and resilience with documented examples (4-5 sentences)",
  "sources": ["key research source 1", "key research source 2", "key research source 3", "consciousness/quantum research source"]
}

Focus on consciousness-expanding insights that bridge science and wisdom. Respond ONLY with valid JSON.`;
        }

        function parseAIResponse(responseText, speciesName) {
            try {
                let cleanedResponse = responseText;
                if (typeof responseText === 'string') {
                    cleanedResponse = responseText
                        .replace(/```json\n?/g, "")
                        .replace(/```\n?/g, "")
                        .trim();
                }
                
                const data = typeof cleanedResponse === 'string' ? JSON.parse(cleanedResponse) : cleanedResponse;
                
                return {
                    species: data.species || speciesName,
                    wisdomInsight: data.wisdomInsight || "This species demonstrates unique intelligence worthy of deeper study.",
                    perceive: data.perceive || { summary: "Advanced perceptual capabilities", details: [] },
                    relate: data.relate || { summary: "Complex relational intelligence", details: [] },
                    apply: data.apply || { summary: "Sophisticated problem-solving abilities", details: [] },
                    humanLearnings: data.humanLearnings || "Valuable lessons for human consciousness evolution",
                    conservationWisdom: data.conservationWisdom || "Important for ecosystem balance and health",
                    quantumAspects: data.quantumAspects || "Consciousness connections being explored by researchers",
                    temporalIntelligence: data.temporalIntelligence || "Sophisticated time perception and seasonal awareness",
                    energeticIntelligence: data.energeticIntelligence || "Biofield sensitivity and energy optimization",
                    collectiveWisdom: data.collectiveWisdom || "Group consciousness and collective decision-making abilities",
                    adaptiveStrategies: data.adaptiveStrategies || "Remarkable adaptation mechanisms and resilience",
                    sources: data.sources || ["Research compilation"],
                    researchBacked: true,
                    timestamp: new Date().toISOString()
                };
            } catch (parseError) {
                console.warn("Failed to parse AI response:", parseError);
                return createEnhancedFallback(speciesName, {});
            }
        }

        function displayEnhancedResults(dataArray) {
            const resultsDiv = document.getElementById('results');
            currentSpeciesData = dataArray;
            
            let html = '<div class="fade-in">';
            
            // Individual species results
            dataArray.forEach((data, index) => {
                html += `
                    <div class="results-container glass">
                        <div class="species-header">
                            <h2>${data.species}</h2>
                            <div class="research-type">
                                ${data.researchBacked ? '🔬 AI-Enhanced Research' : '📋 Enhanced Framework Analysis'}
                            </div>
                        </div>
                        
                        <div class="wisdom-insight">
                            <h3>💡 Key Wisdom</h3>
                            <p>${data.wisdomInsight}</p>
                        </div>
                        
                        <div class="intelligence-framework">
                            <div class="framework-section perceive-section">
                                <h3><span class="framework-badge">PERCEIVE</span> How They Perceive</h3>
                                <p>${data.perceive.summary}</p>
                                <ul class="framework-details">
                                    ${data.perceive.details.map(detail => `<li>${detail}</li>`).join('')}
                                </ul>
                            </div>
                            
                            <div class="framework-section relate-section">
                                <h3><span class="framework-badge">RELATE</span> How They Relate</h3>
                                <p>${data.relate.summary}</p>
                                <ul class="framework-details">
                                    ${data.relate.details.map(detail => `<li>${detail}</li>`).join('')}
                                </ul>
                            </div>
                            
                            <div class="framework-section apply-section">
                                <h3><span class="framework-badge">APPLY</span> How They Apply Intelligence</h3>
                                <p>${data.apply.summary}</p>
                                <ul class="framework-details">
                                    ${data.apply.details.map(detail => `<li>${detail}</li>`).join('')}
                                </ul>
                            </div>
                        </div>

                        <div class="wisdom-insight enhanced-dimension">
                            <h3>🌌 Quantum Biology & Consciousness</h3>
                            <p>${data.quantumAspects}</p>
                        </div>

                        <div class="wisdom-insight temporal-dimension">
                            <h3>⏰ Temporal Intelligence</h3>
                            <p>${data.temporalIntelligence || 'Sophisticated time perception and seasonal awareness patterns that enable environmental synchronization and long-term ecological memory across multiple temporal scales.'}</p>
                        </div>

                        <div class="wisdom-insight energetic-dimension">
                            <h3>⚡ Energetic Intelligence</h3>
                            <p>${data.energeticIntelligence || 'Biofield sensitivity and electromagnetic awareness that enables energy optimization, healing interactions, and quantum field perception for navigation and communication.'}</p>
                        </div>

                        <div class="wisdom-insight collective-dimension">
                            <h3>🤝 Collective Wisdom</h3>
                            <p>${data.collectiveWisdom || 'Group consciousness and collective decision-making abilities that enable distributed intelligence and emergent problem-solving capabilities beyond individual limitations.'}</p>
                        </div>

                        <div class="wisdom-insight adaptive-dimension">
                            <h3>🔄 Adaptive Strategies</h3>
                            <p>${data.adaptiveStrategies || 'Remarkable resilience and real-time adaptation mechanisms that enable survival and thriving across changing environmental conditions through flexible response systems.'}</p>
                        </div>
                        
                        <div class="wisdom-insight enhanced-dimension">
                            <h3>🌱 Human Learning Opportunities</h3>
                            <p>${data.humanLearnings}</p>
                        </div>
                        
                        <div class="wisdom-insight enhanced-dimension">
                            <h3>🌍 Conservation Intelligence</h3>
                            <p>${data.conservationWisdom}</p>
                        </div>
                    </div>
                `;
            });

            // Add comparative analysis if multiple species
            if (dataArray.length > 1) {
                html += generateEnhancedComparativeAnalysis(dataArray);
            }

            // Action buttons with Intelligence Mapping button
            html += `
                <div class="results-container glass">
                    <div class="action-buttons">
                        <button class="action-btn breakdown-btn" onclick="generateEnhancedPDFReport()">
                            📄 Break it Down for Me (Download Comprehensive Report)
                        </button>
                        <button class="action-btn contribute-btn" onclick="showContributionForm()">
                            🤝 Contribute Knowledge
                        </button>
                        <button class="action-btn research-another-btn" onclick="resetSearch()">
                            🔍 Research More Species
                        </button>
                        <button class="action-btn" onclick="showIntelligenceMapping()" style="background: linear-gradient(135deg, #634e87, #9daaec);">
                            🌌 View Intelligence Constellation
                        </button>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px; padding: 15px; background: rgba(111, 154, 76, 0.1); border-radius: 10px; border: 1px solid rgba(111, 154, 76, 0.2);">
                        <div style="margin-bottom: 10px;">
                            <a href="README.md" target="_blank" style="color: #6f9a4c; text-decoration: none; font-weight: 500; font-size: 13px; border-bottom: 1px solid transparent; transition: border-color 0.3s ease;" onmouseover="this.style.borderColor='#6f9a4c'" onmouseout="this.style.borderColor='transparent'">
                                📚 About This Research Platform
                            </a>
                        </div>
                        <small style="color: #47485f; font-size: 12px;">Enhanced research powered by Claude AI with 6 intelligence dimensions • ${dataArray.reduce((sum, d) => sum + (d.sources?.length || 0), 0)} sources consulted</small>
                        <div style="margin-top: 8px;">
                            <small style="color: #634e87; font-size: 11px;">🌌 Species Intelligence Vectors: ${Object.keys(intelligenceVectors).length} mapped</small>
                        </div>
                    </div>
                </div>
            `;

            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        function generateEnhancedComparativeAnalysis(dataArray) {
            const reportSpeciesNames = dataArray.map(d => d.species);
            
            return `
                <div class="comparative-section glass">
                    <h2>🔗 Enhanced Relational Intelligence Patterns</h2>
                    
                    <div class="shared-patterns">
                        <h3>🤝 Universal Intelligence Patterns</h3>
                        <p>Remarkable commonalities emerge across all studied species, revealing fundamental principles of consciousness:</p>
                        <div class="pattern-list">
                            <div style="margin-bottom: 15px;">
                                <strong style="color: #47485f;">TEMPORAL INTELLIGENCE:</strong> All species demonstrate sophisticated time perception that extends far beyond basic circadian rhythms, including seasonal anticipation, multi-generational memory patterns, and environmental change prediction.
                            </div>
                            <div style="margin-bottom: 15px;">
                                <strong style="color: #47485f;">ENERGETIC INTELLIGENCE:</strong> Biofield sensitivity and electromagnetic awareness appear as universal traits, enabling navigation, communication, and environmental monitoring beyond conventional sensory ranges.
                            </div>
                            <div style="margin-bottom: 15px;">
                                <strong style="color: #47485f;">COLLECTIVE INTELLIGENCE:</strong> Group consciousness and distributed decision-making characterize all studied species, creating emergent behaviors that exceed individual capabilities.
                            </div>
                            <div>
                                <strong style="color: #47485f;">ADAPTIVE INTELLIGENCE:</strong> Remarkable resilience and real-time adaptation strategies unite these consciousness expressions, enabling survival across changing environmental conditions.
                            </div>
                        </div>
                    </div>
                    
                    <div class="unique-expressions">
                        <h3>✨ Unique Intelligence Expressions</h3>
                        <p>Each species offers irreplaceable evolutionary gifts that contribute essential capabilities to planetary consciousness:</p>
                        ${reportSpeciesNames.map(species => {
                            const speciesData = dataArray.find(d => d.species === species);
                            return `
                                <div class="species-comparison">
                                    <h4>${species}</h4>
                                    <div><strong>Temporal Gift:</strong> ${(speciesData.temporalIntelligence || 'Sophisticated time perception abilities').substring(0, 120)}...</div>
                                    <div><strong>Energetic Gift:</strong> ${(speciesData.energeticIntelligence || 'Biofield sensitivity and electromagnetic awareness').substring(0, 120)}...</div>
                                    <div><strong>Collective Gift:</strong> ${(speciesData.collectiveWisdom || 'Group consciousness enabling distributed intelligence').substring(0, 120)}...</div>
                                    <div><strong>Adaptive Gift:</strong> ${(speciesData.adaptiveStrategies || 'Remarkable resilience mechanisms').substring(0, 120)}...</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="collective-wisdom">
                        <h3>🌐 Planetary Intelligence Symphony</h3>
                        <p>Together, these ${reportSpeciesNames.length} life forms reveal that intelligence is not a hierarchy but a multidimensional symphony of consciousness, where each species contributes unique temporal, energetic, collective, and adaptive gifts essential for planetary health.</p>
                    </div>
                </div>
            `;
        }

        // Utility functions
        function updateUsageDisplay() {
            const today = new Date().toDateString();
            const todayUsage = dailyUsage[today] || 0;
            const budgetPercent = (monthlySpend / CONFIG.MONTHLY_BUDGET * 100).toFixed(1);
            
            const displayElement = document.getElementById('usageDisplay');
            if (displayElement) {
                displayElement.innerHTML = `
                    Enhanced searches today: ${todayUsage}/${CONFIG.DAILY_SEARCH_LIMIT} | 
                    Monthly budget: ${budgetPercent}% of ${CONFIG.MONTHLY_BUDGET}
                `;
            }
        }

        function initializeConstellation() {
            const canvas = document.getElementById('constellationCanvas');
            const container = document.getElementById('constellationContainer');
            
            if (!canvas || !container) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = container.offsetWidth;
            canvas.height = 400;
            
            ctx.fillStyle = 'rgba(111, 154, 76, 0.3)';
            ctx.font = '16px Poppins';
            ctx.textAlign = 'center';
            ctx.fillText('Enhanced Species Constellation will appear here after research', canvas.width/2, canvas.height/2);
        }

        // Enhanced PDF Generation Function
        function generateEnhancedPDFReport() {
            if (!currentSpeciesData || currentSpeciesData.length === 0) {
                alert('No species data available for PDF generation. Please conduct research first.');
                return;
            }
            
            try {
                if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF) {
                    console.error('jsPDF not loaded properly');
                    alert('PDF library is still loading. Please wait a moment and try again.');
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Title Page
                doc.setFontSize(20);
                doc.text('Species Intelligence Research Report', 20, 30);
                
                doc.setFontSize(14);
                doc.text('Perceive • Relate • Apply Framework with Enhanced Dimensions', 20, 45);
                
                doc.setFontSize(12);
                const speciesNames = currentSpeciesData.map(d => d.species || 'Unknown Species').join(', ');
                doc.text(`Research Focus: ${speciesNames}`, 20, 60);
                
                const reportDate = new Date().toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                doc.text(`Generated: ${reportDate}`, 20, 70);
                doc.text('Powered by Claude AI & Intuitive Learning Foundation Framework', 20, 80);
                
                let yPos = 100;
                
                // Individual Species Reports
                currentSpeciesData.forEach((species, index) => {
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 30;
                    }
                    
                    doc.setFontSize(16);
                    doc.text(`${species.species || 'Unknown Species'} Intelligence Profile`, 20, yPos);
                    yPos += 15;
                    
                    doc.setFontSize(10);
                    doc.text(`Research Type: ${species.researchBacked ? 'AI-Enhanced Research' : 'Framework Analysis'}`, 20, yPos);
                    yPos += 15;
                    
                    // Wisdom Insight
                    doc.setFontSize(12);
                    doc.text('Key Wisdom Insight', 20, yPos);
                    yPos += 8;
                    
                    doc.setFontSize(10);
                    const wisdomLines = doc.splitTextToSize(species.wisdomInsight || 'No wisdom insight available', 170);
                    doc.text(wisdomLines, 20, yPos);
                    yPos += wisdomLines.length * 5 + 10;
                    
                    // Framework sections
                    ['perceive', 'relate', 'apply'].forEach(section => {
                        if (yPos > 250) {
                            doc.addPage();
                            yPos = 30;
                        }
                        
                        doc.setFontSize(12);
                        const sectionTitle = section.toUpperCase() + ' - How They ' + 
                            (section === 'perceive' ? 'Perceive' : section === 'relate' ? 'Relate' : 'Apply Intelligence');
                        doc.text(sectionTitle, 20, yPos);
                        yPos += 8;
                        
                        const sectionData = species[section];
                        if (sectionData && sectionData.summary) {
                            doc.setFontSize(10);
                            const summaryLines = doc.splitTextToSize(sectionData.summary, 170);
                            doc.text(summaryLines, 20, yPos);
                            yPos += summaryLines.length * 5 + 5;
                        }
                        yPos += 10;
                    });
                });
                
                const filename = `Species-Intelligence-Report-${speciesNames.replace(/[^a-zA-Z0-9]/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);
                
                alert(`✅ PDF Report Generated Successfully!\n\nFile: ${filename}`);
                
            } catch (error) {
                console.error('PDF Generation Error:', error);
                alert(`Error generating PDF: ${error.message}\n\nPlease try again or refresh the page.`);
            }
        }

        // Enhanced fallback data functions
        function createEnhancedFallback(speciesName, options) {
            return {
                species: speciesName,
                wisdomInsight: `${speciesName} represents a remarkable form of consciousness that has evolved unique ways of perceiving, relating to, and applying intelligence within their environment.`,
                perceive: {
                    summary: `${speciesName} perceives their world through sophisticated sensory systems adapted to their environmental niche.`,
                    details: ["Specialized sensory capabilities", "Environmental awareness systems", "Social perception abilities", "Quantum field sensitivity"]
                },
                relate: {
                    summary: `${speciesName} maintains relationships through communication and social structures.`,
                    details: ["Social communication systems", "Ecological partnerships", "Community cooperation", "Consciousness connections"]
                },
                apply: {
                    summary: `${speciesName} applies intelligence through problem-solving and adaptive strategies.`,
                    details: ["Problem-solving behaviors", "Environmental adaptation", "Learning systems", "Ecosystem contributions"]
                },
                temporalIntelligence: `${speciesName} demonstrates sophisticated temporal intelligence through synchronization with natural cycles and environmental rhythms.`,
                energeticIntelligence: `${speciesName} exhibits remarkable energetic intelligence through sensitivity to electromagnetic fields and biofield interactions.`,
                collectiveWisdom: `${speciesName} displays sophisticated collective wisdom through group decision-making and information sharing capabilities.`,
                adaptiveStrategies: `${speciesName} exhibits extraordinary adaptive strategies enabling survival across changing environmental conditions.`,
                humanLearnings: `Humans can learn valuable lessons from ${speciesName} about intelligence and environmental adaptation.`,
                conservationWisdom: `${speciesName} plays crucial ecosystem roles requiring conservation for environmental stability.`,
                quantumAspects: `${speciesName} may utilize quantum processes in sensory systems and cognitive processing.`,
                sources: ["Species intelligence research", "Consciousness studies", "Ecological research"],
                researchBacked: false,
                fallbackReason: "Enhanced fallback with ILF integration",
                timestamp: new Date().toISOString()
            };
        }

        // Community contribution handling
        function submitContribution() {
            // Collect form data
            const data = {
                contributorName: document.getElementById('contributorName').value,
                contributorEmail: document.getElementById('contributorEmail').value,
                contributorCredentials: document.getElementById('contributorCredentials').value,
                speciesName: document.getElementById('speciesName').value,
                wisdomInsight: document.getElementById('wisdomInsight').value,
                perceiveData: document.getElementById('perceiveData').value,
                relateData: document.getElementById('relateData').value,
                applyData: document.getElementById('applyData').value,
                humanLearnings: document.getElementById('humanLearnings').value,
                conservationWisdom: document.getElementById('conservationWisdom').value,
                sources: document.getElementById('sources').value,
                experienceType: document.getElementById('experienceType').value,
                accuracy: document.getElementById('accuracy').checked,
                permission: document.getElementById('permission').checked
            };

            // Basic validation
            if (!data.contributorName || !data.contributorEmail || !data.speciesName || 
                !data.wisdomInsight || !data.perceiveData || !data.relateData || 
                !data.applyData || !data.humanLearnings || !data.conservationWisdom || 
                !data.sources || !data.experienceType || !data.accuracy || !data.permission) {
                alert('Please fill in all required fields and check the verification boxes.');
                return;
            }

            // For now, just show success message and close modal
            alert(`Thank you for your contribution about ${data.speciesName}! Your knowledge has been recorded and will be reviewed for inclusion in our research database.`);
            closeContributionModal();
            
            // Clear the form
            document.getElementById('contributionForm').reset();
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            updateUsageDisplay();
            initializeConstellation();
            
            // Add enter key support
            const inputs = document.querySelectorAll('.species-input');
            inputs.forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        conductResearch();
                    }
                });
            });
        });

        // Make all functions globally accessible for HTML onclick handlers
        window.conductResearch = conductResearch;
        window.showContributionForm = showContributionForm;
        window.closeContributionModal = closeContributionModal;
        window.submitContribution = submitContribution;
        window.generateEnhancedPDFReport = generateEnhancedPDFReport;
        window.resetSearch = resetSearch;
        window.showIntelligenceMapping = showIntelligenceMapping;
        window.exportConstellationData = exportConstellationData;
    </script>
</body>
</html>
