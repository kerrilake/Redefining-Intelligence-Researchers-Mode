<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Species Intelligence Research Agent - Redefining Intelligence</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        .header {
            text-align: center;
            padding: 40px 20px;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            color: white;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1em;
            font-style: italic;
        }

        .search-section {
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }

        .search-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .species-input {
            padding: 15px;
            font-size: 16px;
            border: none;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        .species-input:focus {
            outline: none;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .options-section {
            margin: 20px 0;
            text-align: left;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 15px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
        }

        .checkbox-item input[type="checkbox"] {
            transform: scale(1.2);
        }

        .research-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin: 20px 10px;
        }

        .research-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .research-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .results-container {
            padding: 30px;
            margin: 20px 0;
            position: relative;
        }

        .species-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .species-header h2 {
            font-size: 2.2em;
            color: #333;
            margin-bottom: 10px;
        }

        .research-type {
            display: inline-block;
            background: linear-gradient(135deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .wisdom-insight {
            text-align: center;
            padding: 25px;
            margin: 25px 0;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 165, 0, 0.2));
            border-radius: 15px;
            border-left: 5px solid #FFD700;
        }

        .wisdom-insight h3 {
            color: #B8860B;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .wisdom-insight p {
            font-size: 1.1em;
            line-height: 1.6;
            color: #333;
            font-style: italic;
        }

        .intelligence-framework {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .framework-section {
            padding: 25px;
            border-radius: 15px;
            position: relative;
            backdrop-filter: blur(5px);
        }

        .perceive-section {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(129, 199, 132, 0.3));
            border-left: 5px solid #4CAF50;
        }

        .relate-section {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.3), rgba(100, 181, 246, 0.3));
            border-left: 5px solid #2196F3;
        }

        .apply-section {
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.3), rgba(186, 104, 200, 0.3));
            border-left: 5px solid #9C27B0;
        }

        .framework-section h3 {
            font-size: 1.4em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .framework-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .framework-section p {
            line-height: 1.6;
            margin-bottom: 15px;
            color: white;
            font-weight: 500;
        }

        .framework-details {
            list-style: none;
            padding: 0;
        }

        .framework-details li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            position: relative;
            padding-left: 20px;
            color: white;
            font-weight: 500;
        }

        .framework-details li:before {
            content: "•";
            position: absolute;
            left: 0;
            color: white;
            font-weight: bold;
        }

        .comparative-section {
            margin: 40px 0;
            padding: 30px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(167, 139, 250, 0.3));
            border-radius: 20px;
            border-left: 5px solid #8B5CF6;
        }

        .comparative-section h2 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .shared-patterns, .unique-expressions {
            margin: 25px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }

        .shared-patterns h3, .unique-expressions h3 {
            color: #E0E7FF;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .shared-patterns p, .unique-expressions p {
            color: #E0E7FF;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .pattern-list {
            color: white;
            font-weight: 500;
        }

        .species-comparison {
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
        }

        .species-comparison h4 {
            color: #FDE68A;
            margin-bottom: 10px;
        }

        .species-comparison div {
            color: white;
            font-size: 0.9em;
            line-height: 1.4;
            margin-bottom: 5px;
        }

        .collective-wisdom {
            text-align: center;
            padding: 25px;
            margin: 25px 0;
            background: linear-gradient(135deg, rgba(45, 212, 191, 0.3), rgba(34, 197, 94, 0.3));
            border-radius: 15px;
            border-left: 5px solid #2DD4BF;
        }

        .collective-wisdom h3 {
            color: #ECFDF5;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .collective-wisdom p {
            color: #ECFDF5;
            font-size: 1.1em;
            line-height: 1.6;
            font-style: italic;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .action-btn {
            flex: 1;
            min-width: 200px;
            padding: 15px 25px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .breakdown-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .contribute-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .research-another-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .loading-enhanced {
            text-align: center;
            padding: 60px 20px;
            margin: 20px 0;
        }

        .research-animation {
            font-size: 64px;
            animation: research-pulse 2s infinite;
            margin-bottom: 20px;
        }

        @keyframes research-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .usage-stats {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 12px;
            z-index: 100;
        }

        .constellation-container {
            height: 400px;
            margin: 30px 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            position: relative;
            overflow: hidden;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            margin: 3% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
        }

        .form-group {
            margin: 20px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.9);
            font-family: inherit;
        }

        .fade-in {
            animation: fadeIn 0.6s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .search-grid {
                grid-template-columns: 1fr;
            }

            .intelligence-framework {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-btn {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header glass">
            <h1>Species Intelligence Research Agent</h1>
            <p>Redefining Intelligence Through the Perceive • Relate • Apply Framework</p>
        </header>

        <section class="search-section glass">
            <h2 style="color: white; margin-bottom: 20px;">Explore Species Intelligence</h2>
            
            <div class="search-grid">
                <input type="text" class="species-input" id="species1" placeholder="Enter first species (e.g., dolphins)" />
                <input type="text" class="species-input" id="species2" placeholder="Enter second species (optional)" />
                <input type="text" class="species-input" id="species3" placeholder="Enter third species (optional)" />
                <input type="text" class="species-input" id="species4" placeholder="Enter fourth species (optional)" />
                <input type="text" class="species-input" id="species5" placeholder="Enter fifth species (optional)" />
            </div>

            <div class="options-section">
                <h3 style="color: white; margin-bottom: 15px;">Enhanced Research Options</h3>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="includeIndigenous" />
                        <label for="includeIndigenous">Include Indigenous Knowledge</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="includeBiomimicry" />
                        <label for="includeBiomimicry">Include Biomimicry Applications</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="includeHuman" />
                        <label for="includeHuman">Compare with Human Intelligence</label>
                    </div>
                </div>
            </div>

            <button class="research-btn" onclick="conductResearch()">
                🔬 Reveal Intelligence
            </button>
            
            <button class="research-btn" onclick="showContributionForm()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); margin-left: 10px;">
                🤝 Contribute Knowledge
            </button>

            <div style="margin-top: 20px;">
                <div id="usageDisplay" style="color: white; font-size: 14px;"></div>
            </div>
        </section>

        <div id="constellationContainer" class="constellation-container glass" style="display: none;">
            <canvas id="constellationCanvas" width="100%" height="400"></canvas>
        </div>

        <div id="results"></div>

        <div class="usage-stats" id="usageStats"></div>
    </div>

    <!-- Community Contribution Modal -->
    <div id="contributionModal" class="modal">
        <div class="modal-content glass">
            <span style="position: absolute; right: 20px; top: 15px; font-size: 28px; font-weight: bold; cursor: pointer; color: #666;" onclick="closeContributionModal()">&times;</span>
            <h3>Contribute Species Intelligence Knowledge</h3>
            <p>Share your research, observations, or insights about species intelligence</p>
            
            <form id="contributionForm">
                <div class="form-group">
                    <label for="contributorName">Your Name/Organization *:</label>
                    <input type="text" id="contributorName" required>
                </div>
                
                <div class="form-group">
                    <label for="contributorEmail">Email (for verification) *:</label>
                    <input type="email" id="contributorEmail" required>
                </div>
                
                <div class="form-group">
                    <label for="contributorCredentials">Credentials/Background:</label>
                    <input type="text" id="contributorCredentials" placeholder="PhD in Biology, Indigenous Elder, Professional Animal Communicator, etc.">
                </div>
                
                <div class="form-group">
                    <label for="speciesName">Species Name *:</label>
                    <input type="text" id="speciesName" required>
                </div>
                
                <div class="form-group">
                    <label for="wisdomInsight">Key Wisdom Insight *:</label>
                    <textarea id="wisdomInsight" rows="3" required 
                            placeholder="What profound insight about this species' intelligence should people know?"></textarea>
                </div>
                
                <div style="background: rgba(78, 205, 196, 0.1); padding: 20px; border-radius: 12px; margin: 20px 0;">
                    <h4 style="color: #4ECDC4; margin-bottom: 12px;">PERCEIVE - How they perceive their world:</h4>
                    <textarea id="perceiveData" rows="4" required
                            placeholder="Describe their sensory capabilities, environmental awareness, unique perceptual gifts..."></textarea>
                </div>
                
                <div style="background: rgba(78, 205, 196, 0.1); padding: 20px; border-radius: 12px; margin: 20px 0;">
                    <h4 style="color: #4ECDC4; margin-bottom: 12px;">RELATE - How they relate to their world:</h4>
                    <textarea id="relateData" rows="4" required
                            placeholder="Social structures, communication, ecological relationships, cultural significance..."></textarea>
                </div>
                
                <div style="background: rgba(78, 205, 196, 0.1); padding: 20px; border-radius: 12px; margin: 20px 0;">
                    <h4 style="color: #4ECDC4; margin-bottom: 12px;">APPLY - How they apply their intelligence:</h4>
                    <textarea id="applyData" rows="4" required
                            placeholder="Problem-solving, tool use, learning, ecosystem contributions..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="humanLearnings">What humans can learn from this species *:</label>
                    <textarea id="humanLearnings" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="conservationWisdom">Conservation intelligence insights *:</label>
                    <textarea id="conservationWisdom" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="sources">Sources/References (required) *:</label>
                    <textarea id="sources" rows="4" required
                            placeholder="List your sources: research papers, traditional knowledge, personal observation, etc. At least 2 sources required."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="experienceType">Type of contribution *:</label>
                    <select id="experienceType" required>
                        <option value="">Select type</option>
                        <option value="scientific">Scientific Research</option>
                        <option value="indigenous">Indigenous/Traditional Knowledge</option>
                        <option value="observation">Field Observation</option>
                        <option value="interspecies">Interspecies Communication</option>
                        <option value="biomimicry">Biomimicry Application</option>
                        <option value="conservation">Conservation Experience</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="accuracy" required>
                        <label for="accuracy">I verify that this information is accurate to the best of my knowledge *</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="permission" required>
                        <label for="permission">I give permission for this contribution to be used in the Species Intelligence Research database *</label>
                    </div>
                </div>
                
                <button type="submit" style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%; margin-top: 20px;">Submit Contribution</button>
            </form>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            DAILY_SEARCH_LIMIT: 6,
            MONTHLY_BUDGET: 100,
            COST_PER_SEARCH: 0.50, // Estimated average
            EMAIL_THRESHOLD: 80 // Notify at 80% of budget
        };

        // Global state
        let currentSpeciesData = [];
        let researchHistory = JSON.parse(localStorage.getItem('researchHistory') || '[]');
        let dailyUsage = JSON.parse(localStorage.getItem('dailyUsage') || '{}');
        let monthlySpend = parseFloat(localStorage.getItem('monthlySpend') || '0');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateUsageDisplay();
            initializeConstellation();
            
            // Add enter key support
            const inputs = document.querySelectorAll('.species-input');
            inputs.forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        conductResearch();
                    }
                });
            });
        });

        // FIXED AI API Integration
        async function callAnthropicAPI(speciesName, options) {
            console.log('=== CALLING API FOR:', speciesName, '===');
            
            const prompt = createResearchPrompt(speciesName, options);
            
            try {
                console.log('Making request to Netlify function...');
                
                const response = await fetch('/.netlify/functions/research-species', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        species: speciesName,
                        prompt: prompt,
                        options: options
                    })
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error:', errorText);
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                console.log('Received data:', data);
                
                // Check if we got a successful response
                if (data.success && data.response) {
                    console.log('✅ AI API call successful for', speciesName);
                    return data.response;
                } else {
                    console.warn('⚠️ API returned data but no success flag:', data);
                    // Still try to use the response if it exists
                    return data.response || data;
                }
                
            } catch (error) {
                console.error('❌ AI API Error for', speciesName, ':', error);
                console.log('🔄 Falling back to enhanced local data');
                
                // Fallback to enhanced local data with clear indication
                const fallbackData = createEnhancedFallback(speciesName, options);
                fallbackData.fallbackReason = `API Error: ${error.message}`;
                fallbackData.researchBacked = false;
                return fallbackData;
            }
        }

        function createResearchPrompt(speciesName, options) {
            const indigenousKnowledge = options.includeIndigenous ? `
- Indigenous wisdom and traditional ecological knowledge from various cultures
- Sacred relationships and ceremonial connections with this species
- Traditional uses and spiritual significance across different indigenous traditions` : '';

            const biomimicryApplications = options.includeBiomimicry ? `
- Current biomimicry applications inspired by this species
- Potential future technological innovations based on their capabilities
- Economic and environmental impact of species-inspired technologies` : '';

            return `You are a multidisciplinary species intelligence researcher specializing in consciousness studies and quantum biology. Research ${speciesName} through the revolutionary "Perceive/Relate/Apply" intelligence framework developed by Kerri Lake.

RESEARCH REQUIREMENTS:
1. PERCEIVE: How does ${speciesName} perceive their world?
   - Sensory capabilities and unique perceptual gifts
   - Environmental awareness and information processing
   - Quantum sensing abilities and field perception
   - Survival perception mechanisms

2. RELATE: How does ${speciesName} relate to their world?
   - Social structures and communication methods
   - Ecological relationships and symbiosis
   - Emotional and energetic connections
   - Cultural significance in human societies
   - Interspecies relationship patterns

3. APPLY: How does ${speciesName} apply their intelligence?
   - Problem-solving behaviors and adaptations
   - Tool use and environmental manipulation
   - Learning, memory, and knowledge transfer
   - Contributions to ecosystem health and balance

SOURCES TO CONSULT:
- Peer-reviewed biology, ecology, ethology, and neuroscience research
- Consciousness and quantum biology studies including work by William Brown and Nassim Haramein
- Research from Earth Species Project and Melanie Challenger's work${indigenousKnowledge}${biomimicryApplications}
- Behavioral studies and cognitive research
- Conservation and environmental research

RESPONSE FORMAT:
Provide a JSON response with this exact structure:
{
  "species": "${speciesName}",
  "wisdomInsight": "One profound insight about this species' intelligence that could expand human consciousness (2-3 sentences)",
  "perceive": {
    "summary": "How they perceive their world (2-3 sentences)",
    "details": ["specific perceptual capability 1", "specific perceptual capability 2", "specific perceptual capability 3", "quantum/field perception aspect"]
  },
  "relate": {
    "summary": "How they relate to their world (2-3 sentences)", 
    "details": ["relationship aspect 1", "relationship aspect 2", "relationship aspect 3", "consciousness connection aspect"]
  },
  "apply": {
    "summary": "How they apply intelligence (2-3 sentences)",
    "details": ["application example 1", "application example 2", "application example 3", "ecosystem contribution"]
  },
  "humanLearnings": "What humans can learn from ${speciesName}'s intelligence for consciousness evolution",
  "conservationWisdom": "How their intelligence relates to conservation needs and ecosystem health",
  "quantumAspects": "Quantum biology and consciousness connections documented in research",
  "sources": ["key research source 1", "key research source 2", "key research source 3", "consciousness/quantum research source"]
}

Focus on consciousness-expanding insights that bridge science and wisdom. Respond ONLY with valid JSON.`;
        }

        function parseAIResponse(responseText, speciesName) {
            try {
                console.log('Parsing AI response for:', speciesName);
                console.log('Response text preview:', responseText.substring(0, 100) + '...');
                
                const cleanedResponse = responseText
                    .replace(/```json\n?/g, "")
                    .replace(/```\n?/g, "")
                    .trim();
                
                const data = JSON.parse(cleanedResponse);
                
                return {
                    species: data.species || speciesName,
                    wisdomInsight: data.wisdomInsight || "This species demonstrates unique intelligence worthy of deeper study.",
                    perceive: data.perceive || { summary: "Advanced perceptual capabilities", details: [] },
                    relate: data.relate || { summary: "Complex relational intelligence", details: [] },
                    apply: data.apply || { summary: "Sophisticated problem-solving abilities", details: [] },
                    humanLearnings: data.humanLearnings || "Valuable lessons for human consciousness evolution",
                    conservationWisdom: data.conservationWisdom || "Important for ecosystem balance and health",
                    quantumAspects: data.quantumAspects || "Consciousness connections being explored by researchers",
                    sources: data.sources || ["Research compilation"],
                    researchBacked: true,
                    timestamp: new Date().toISOString()
                };
            } catch (parseError) {
                console.warn("Failed to parse AI response:", parseError);
                console.log("Raw response that failed to parse:", responseText);
                return createEnhancedFallback(speciesName, {});
            }
        }

        // Updated main research function with better debugging
        async function conductResearch() {
            const speciesInputs = [
                document.getElementById('species1').value.trim(),
                document.getElementById('species2').value.trim(),
                document.getElementById('species3').value.trim(),
                document.getElementById('species4').value.trim(),
                document.getElementById('species5').value.trim()
            ].filter(species => species.length > 0);

            if (speciesInputs.length === 0) {
                alert('Please enter at least one species name');
                return;
            }

            // Check daily limits
            const today = new Date().toDateString();
            if (!dailyUsage[today]) dailyUsage[today] = 0;
            
            if (dailyUsage[today] >= CONFIG.DAILY_SEARCH_LIMIT) {
                alert(`Daily search limit reached (${CONFIG.DAILY_SEARCH_LIMIT} searches). Please try again tomorrow or contact info@kerrilake.com for extended access.`);
                return;
            }

            const options = {
                includeIndigenous: document.getElementById('includeIndigenous').checked,
                includeBiomimicry: document.getElementById('includeBiomimicry').checked,
                includeHuman: document.getElementById('includeHuman').checked
            };

            if (options.includeHuman) {
                speciesInputs.push('Human');
            }

            const resultsDiv = document.getElementById('results');
            
            try {
                console.log('🔬 Starting research for:', speciesInputs);
                console.log('🎛️ Options:', options);
                
                // Show loading
                resultsDiv.innerHTML = `
                    <div class="results-container glass fade-in">
                        <div class="loading-enhanced">
                            <div class="research-animation">🧬</div>
                            <h3>Conducting Deep Species Intelligence Research</h3>
                            <p>Calling Claude AI for authentic research on ${speciesInputs.length} species</p>
                            <p style="color: rgba(255,255,255,0.7); font-size: 14px; margin-top: 10px;">This may take 10-15 seconds per species...</p>
                        </div>
                    </div>
                `;

                // Call AI API for each species
                const researchResults = [];
                for (let i = 0; i < speciesInputs.length; i++) {
                    const species = speciesInputs[i];
                    console.log(`🔍 Researching ${i + 1}/${speciesInputs.length}: ${species}`);
                    
                    // Update loading message
                    resultsDiv.innerHTML = `
                        <div class="results-container glass fade-in">
                            <div class="loading-enhanced">
                                <div class="research-animation">🧬</div>
                                <h3>Researching ${species}...</h3>
                                <p>Species ${i + 1} of ${speciesInputs.length} • Calling Claude AI</p>
                                <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; margin: 10px 0;">
                                    <div style="width: ${(i/speciesInputs.length)*100}%; height: 4px; background: #4CAF50; border-radius: 2px;"></div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    const result = await callAnthropicAPI(species, options);
                    researchResults.push(result);
                    
                    console.log(`✅ Completed research for ${species}:`, result.researchBacked ? 'AI-powered' : 'Fallback data');
                }

                console.log('🎉 All research completed!');
                console.log('Results summary:', researchResults.map(r => ({
                    species: r.species,
                    aiBacked: r.researchBacked,
                    fallbackReason: r.fallbackReason
                })));

                // Update usage tracking
                dailyUsage[today]++;
                monthlySpend += CONFIG.COST_PER_SEARCH * speciesInputs.length;
                localStorage.setItem('dailyUsage', JSON.stringify(dailyUsage));
                localStorage.setItem('monthlySpend', monthlySpend.toString());

                // Check budget threshold
                if (monthlySpend >= CONFIG.MONTHLY_BUDGET * (CONFIG.EMAIL_THRESHOLD / 100)) {
                    await sendBudgetNotification(monthlySpend);
                }

                // Store in research history
                const searchRecord = {
                    species: speciesInputs,
                    timestamp: new Date().toISOString(),
                    options: options,
                    results: researchResults
                };
                researchHistory.push(searchRecord);
                localStorage.setItem('researchHistory', JSON.stringify(researchHistory));

                // Display results
                displayResults(researchResults);
                updateUsageDisplay();
                updateConstellation(researchResults);
                
            } catch (error) {
                console.error('❌ Research failed:', error);
                resultsDiv.innerHTML = `
                    <div class="results-container glass fade-in">
                        <div style="text-align: center; padding: 40px;">
                            <h3 style="color: #e74c3c;">Research Temporarily Unavailable</h3>
                            <p style="color: #333;">Error: ${error.message}</p>
                            <p style="color: #666; font-size: 14px; margin-top: 15px;">Check the browser console (F12) for more details.</p>
                            <button onclick="conductResearch()" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; border: none; padding: 12px 25px; border-radius: 20px; cursor: pointer; margin-top: 15px;">Try Again</button>
                        </div>
                    </div>
                `;
            }
        }

        function createEnhancedFallback(speciesName, options) {
            // Enhanced fallback data for when AI is unavailable
            const speciesData = getSpeciesSpecificData(speciesName);
            
            let additionalDetails = [];
            
            if (options.includeIndigenous) {
                additionalDetails.push("Traditional ecological knowledge recognizes their unique perceptual gifts");
                additionalDetails.push("Sacred relationships with this species across indigenous cultures");
            }
            
            if (options.includeBiomimicry) {
                additionalDetails.push("Current and potential biomimicry applications inspired by their unique capabilities");
                additionalDetails.push("Technological innovations that could emerge from studying their intelligence");
            }
            
            return {
                species: speciesName,
                wisdomInsight: speciesData.wisdomInsight,
                perceive: {
                    summary: speciesData.perceive.summary,
                    details: [...speciesData.perceive.details, ...additionalDetails.slice(0, 2)]
                },
                relate: {
                    summary: speciesData.relate.summary,
                    details: [...speciesData.relate.details, ...additionalDetails.slice(2, 4)]
                },
                apply: {
                    summary: speciesData.apply.summary,
                    details: [...speciesData.apply.details, "Ecosystem intelligence contributions", "Adaptive learning mechanisms"]
                },
                humanLearnings: speciesData.humanLearnings,
                conservationWisdom: speciesData.conservationWisdom,
                quantumAspects: speciesData.quantumAspects,
                sources: speciesData.sources,
                researchBacked: false,
                fallbackReason: "Using enhanced local database",
                timestamp: new Date().toISOString()
            };
        }

        function getSpeciesSpecificData(speciesName) {
            const species = speciesName.toLowerCase();
            
            const speciesDatabase = {
                dolphin: {
                    wisdomInsight: "Dolphins embody the synthesis of intelligence, play, and consciousness, demonstrating that advanced cognition naturally includes joy, creativity, and interspecies communication.",
                    perceive: {
                        summary: "Dolphins perceive through echolocation, electromagnetic sensing, and quantum field awareness that creates a three-dimensional sonic picture of their world.",
                        details: [
                            "Biosonar echolocation creating detailed internal imagery",
                            "Electromagnetic field navigation for long-distance migration", 
                            "Quantum entanglement in pod communication systems",
                            "Multi-dimensional acoustic processing of environmental information"
                        ]
                    },
                    relate: {
                        summary: "Dolphins relate through complex pod societies, interspecies play, and sophisticated communication that includes signature whistles and telepathic connections.",
                        details: [
                            "Individual signature whistles functioning as names",
                            "Cross-species play and communication with humans",
                            "Cooperative hunting strategies across pod networks",
                            "Grief rituals and emotional support systems"
                        ]
                    },
                    apply: {
                        summary: "Dolphins apply intelligence through problem-solving, tool use, cultural transmission, and healing interactions with other species including humans.",
                        details: [
                            "Tool use with sponges for foraging protection",
                            "Cultural transmission of hunting techniques across generations",
                            "Therapeutic interactions with humans and other injured animals",
                            "Creative play that serves cognitive development"
                        ]
                    },
                    humanLearnings: "Dolphins teach humans that intelligence without joy is incomplete. Their integration of play, cooperation, and problem-solving offers a model for conscious evolution that includes both wisdom and delight.",
                    conservationWisdom: "Dolphin intelligence represents millions of years of oceanic consciousness evolution. Protecting them preserves forms of communication and awareness that could unlock understanding of planetary consciousness networks.",
                    quantumAspects: "Marine biologists are investigating quantum coherence in dolphin echolocation systems, suggesting their sonic abilities may utilize quantum mechanical principles for enhanced perception and communication.",
                    sources: ["Marine mammal cognition research", "Dolphin echolocation studies", "Interspecies communication research", "Quantum biology in marine mammals"]
                },
                
                salamander: {
                    wisdomInsight: "Salamanders demonstrate the intelligence of regeneration and transformation, showing that consciousness includes the ability to rebuild and renew at the cellular level while maintaining identity and memory.",
                    perceive: {
                        summary: "Salamanders perceive through highly sensitive skin that acts as both respiratory and sensory organ, detecting chemical gradients, moisture levels, and electromagnetic fields.",
                        details: [
                            "Skin-based chemoreception detecting molecular environmental changes",
                            "Electromagnetic field sensitivity for navigation and predator detection",
                            "Vibration sensing through substrate contact for territorial awareness",
                            "Regenerative tissue intelligence that maintains spatial memory during regrowth"
                        ]
                    },
                    relate: {
                        summary: "Salamanders relate to their ecosystem through moisture-dependent connections, seasonal migrations, and symbiotic relationships with forest floor communities.",
                        details: [
                            "Moisture-gradient navigation linking aquatic and terrestrial ecosystems",
                            "Chemical communication through pheromone trails and territorial marking",
                            "Prey-predator balance maintenance in forest floor food webs",
                            "Seasonal breeding aggregations demonstrating collective timing intelligence"
                        ]
                    },
                    apply: {
                        summary: "Salamanders apply their intelligence through perfect regeneration, environmental adaptation, and ecosystem engineering that creates micro-habitats for other species.",
                        details: [
                            "Complete limb and organ regeneration while retaining memory and function",
                            "Soil aeration and nutrient cycling through burrowing behaviors",
                            "Prey population regulation maintaining ecosystem balance",
                            "Climate change adaptation through altitude and latitude migration"
                        ]
                    },
                    humanLearnings: "Humans can learn about healing, regeneration, and the intelligence of tissues from salamanders. Their ability to regrow complex structures offers insights into consciousness-directed healing and cellular renewal.",
                    conservationWisdom: "Salamander populations serve as indicators of ecosystem health. Their regenerative abilities represent biological wisdom about healing that could revolutionize human medicine and environmental restoration.",
                    quantumAspects: "Research suggests salamander regeneration involves quantum field organization at the cellular level, with bioelectric patterns guiding tissue reconstruction through morphogenetic fields.",
                    sources: ["Regenerative biology research", "Amphibian ecology studies", "Bioelectric field research", "Morphogenetic field studies"]
                },

                human: {
                    wisdomInsight: "Humans represent a unique form of consciousness that bridges linear thinking with intuitive awareness, capable of both technological innovation and spiritual evolution.",
                    perceive: {
                        summary: "Humans perceive through sensory integration, pattern recognition, and consciousness-based awareness that extends beyond physical senses.",
                        details: [
                            "Multi-sensory integration creating unified perceptual experiences",
                            "Abstract pattern recognition and symbolic thinking",
                            "Intuitive and psychic perception beyond ordinary senses",
                            "Cultural and linguistic filtering of perceptual experience"
                        ]
                    },
                    relate: {
                        summary: "Humans relate through language, empathy, cultural systems, and expanding consciousness connections with all life forms.",
                        details: [
                            "Complex linguistic communication and storytelling",
                            "Empathic resonance and emotional mirroring",
                            "Cultural meaning-making and shared belief systems",
                            "Expanding interspecies communication and nature connection"
                        ]
                    },
                    apply: {
                        summary: "Humans apply intelligence through technology, creativity, conscious choice-making, and potential co-evolution with all life on Earth.",
                        details: [
                            "Technological innovation and environmental manipulation",
                            "Artistic and creative expression across multiple mediums",
                            "Conscious evolution and spiritual development practices",
                            "Collaborative problem-solving and collective intelligence"
                        ]
                    },
                    humanLearnings: "Humans are learning to integrate their unique gifts of abstract thinking and creativity with the wisdom of other species, potentially leading to a new form of planetary consciousness.",
                    conservationWisdom: "Human intelligence carries the responsibility of protecting and honoring all forms of life, recognizing that human consciousness evolution depends on the health of the entire planetary ecosystem.",
                    quantumAspects: "Emerging research in human consciousness suggests quantum processes in microtubules may be fundamental to human awareness, connecting individual consciousness to universal information fields.",
                    sources: ["Consciousness research", "Quantum biology studies", "Anthropological research", "Cognitive science"]
                }
            };
            
            return speciesDatabase[species] || {
                wisdomInsight: `${speciesName} represents a unique form of intelligence that bridges scientific understanding with consciousness wisdom, offering humanity profound lessons about life and awareness.`,
                perceive: {
                    summary: `${speciesName} perceives their world through evolved sensory adaptations and consciousness-based awareness that extends beyond current scientific understanding.`,
                    details: [
                        "Species-specific sensory capabilities adapted to their environment",
                        "Environmental awareness mechanisms for survival and thriving",
                        "Social and emotional perception within their community",
                        "Potential quantum field sensitivity and morphic resonance"
                    ]
                },
                relate: {
                    summary: `${speciesName} maintains complex relationships within their ecosystem and consciousness network, contributing to the web of planetary intelligence.`,
                    details: [
                        "Ecological connections and symbiotic relationships",
                        "Intraspecies communication and social structures",
                        "Interspecies relationships and ecosystem contributions",
                        "Energetic and consciousness connections with other life forms"
                    ]
                },
                apply: {
                    summary: `${speciesName} applies their intelligence for survival, thriving, and ecosystem contribution while maintaining harmony with natural systems.`,
                    details: [
                        "Adaptive problem-solving behaviors",
                        "Environmental manipulation and habitat optimization",
                        "Learning and memory applications across generations",
                        "Ecosystem intelligence contributions and balance maintenance"
                    ]
                },
                humanLearnings: `Humans can learn about adaptation, resilience, consciousness expansion, and natural harmony from ${speciesName}. Their approach to life offers insights into sustainable living and authentic relationship with the natural world.`,
                conservationWisdom: `Protecting ${speciesName} preserves unique forms of intelligence essential for planetary health and consciousness evolution. Each species represents irreplaceable wisdom about life's creative intelligence.`,
                quantumAspects: "Quantum biology research suggests consciousness connections across all life forms, with emerging studies on biofield interactions and morphic resonance patterns.",
                sources: ["Enhanced species intelligence framework", "Consciousness and biology research", "Ecological intelligence studies", "Interspecies communication research"]
            };
        }

        function displayResults(dataArray) {
            const resultsDiv = document.getElementById('results');
            currentSpeciesData = dataArray;
            
            let html = '<div class="fade-in">';
            
            // Individual species results
            dataArray.forEach((data, index) => {
                html += `
                    <div class="results-container glass">
                        <div class="species-header">
                            <h2>${data.species}</h2>
                            <div class="research-type">
                                ${data.researchBacked ? '🔬 AI-Enhanced Research' : '📋 Enhanced Framework Analysis'}
                            </div>
                        </div>
                        
                        <div class="wisdom-insight">
                            <h3>💡 Key Wisdom</h3>
                            <p>${data.wisdomInsight}</p>
                        </div>
                        
                        <div class="intelligence-framework">
                            <div class="framework-section perceive-section">
                                <h3><span class="framework-badge">PERCEIVE</span> How They Perceive</h3>
                                <p>${data.perceive.summary}</p>
                                <ul class="framework-details">
                                    ${data.perceive.details.map(detail => `<li>${detail}</li>`).join('')}
                                </ul>
                            </div>
                            
                            <div class="framework-section relate-section">
                                <h3><span class="framework-badge">RELATE</span> How They Relate</h3>
                                <p>${data.relate.summary}</p>
                                <ul class="framework-details">
                                    ${data.relate.details.map(detail => `<li>${detail}</li>`).join('')}
                                </ul>
                            </div>
                            
                            <div class="framework-section apply-section">
                                <h3><span class="framework-badge">APPLY</span> How They Apply Intelligence</h3>
                                <p>${data.apply.summary}</p>
                                <ul class="framework-details">
                                    ${data.apply.details.map(detail => `<li>${detail}</li>`).join('')}
                                </ul>
                            </div>
                        </div>

                        <div class="wisdom-insight" style="background: linear-gradient(135deg, rgba(147, 51, 234, 0.3), rgba(79, 70, 229, 0.3)); border-left-color: #9333ea;">
                            <h3>🌌 Quantum Biology & Consciousness</h3>
                            <p>${data.quantumAspects}</p>
                        </div>
                        
                        <div class="wisdom-insight" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(16, 185, 129, 0.3)); border-left-color: #22c55e;">
                            <h3>🌱 Human Learning Opportunities</h3>
                            <p>${data.humanLearnings}</p>
                        </div>
                        
                        <div class="wisdom-insight" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(147, 197, 253, 0.3)); border-left-color: #3b82f6;">
                            <h3>🌍 Conservation Intelligence</h3>
                            <p>${data.conservationWisdom}</p>
                        </div>
                    </div>
                `;
            });

            // Add comparative analysis if multiple species
            if (dataArray.length > 1) {
                html += generateComparativeAnalysis(dataArray);
            }

            // Action buttons
            html += `
                <div class="results-container glass">
                    <div class="action-buttons">
                        <button class="action-btn breakdown-btn" onclick="generatePDFReport()">
                            📄 Break it Down for Me (Download Full Report)
                        </button>
                        <button class="action-btn contribute-btn" onclick="showContributionForm()">
                            🤝 Contribute Knowledge
                        </button>
                        <button class="action-btn research-another-btn" onclick="resetSearch()">
                            🔍 Research More Species
                        </button>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 10px;">
                        <small style="color: #666; font-size: 12px;">Research powered by Claude AI with consciousness-enhanced framework • ${dataArray.reduce((sum, d) => sum + (d.sources?.length || 0), 0)} sources consulted</small>
                    </div>
                </div>
            `;

            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        function generateComparativeAnalysis(dataArray) {
            const speciesNames = dataArray.map(d => d.species);
            
            // Analyze shared patterns
            const sharedPatterns = {
                perceive: [
                    "All demonstrate sophisticated environmental awareness beyond human scientific understanding",
                    "Electromagnetic and quantum field sensitivity appears across multiple species"
                ],
                relate: [
                    "Each contributes to the web of planetary consciousness and ecosystem intelligence", 
                    "Complex communication systems unite these life forms"
                ],
                apply: [
                    "All apply their intelligence to maintain balance within natural systems",
                    "Adaptive learning and problem-solving intelligence spans all these species"
                ]
            };

            // Identify unique traits
            const uniqueTraits = {};
            dataArray.forEach(data => {
                const species = data.species;
                
                if (species.toLowerCase() === 'horse') {
                    uniqueTraits[species] = {
                        perceive: "Unique empathic mirroring of human emotional states",
                        relate: "Therapeutic relationship capacity with humans", 
                        apply: "Healing facilitation through energetic presence"
                    };
                } else if (species.toLowerCase() === 'dolphin') {
                    uniqueTraits[species] = {
                        perceive: "Echolocation creating three-dimensional sonic imagery",
                        relate: "Signature whistles functioning as individual names",
                        apply: "Joy and play integrated into intelligence expression"
                    };
                } else if (species.toLowerCase() === 'human') {
                    uniqueTraits[species] = {
                        perceive: "Abstract symbolic thinking and pattern recognition",
                        relate: "Complex linguistic and cultural meaning-making systems",
                        apply: "Technological innovation and conscious evolution potential"
                    };
                } else {
                    uniqueTraits[species] = {
                        perceive: `Species-specific sensory adaptations unique to ${species}`,
                        relate: `Distinctive ecological relationships that ${species} alone can fulfill`,
                        apply: `Specialized intelligence applications that make ${species} irreplaceable`
                    };
                }
            });
            
            return `
                <div class="comparative-section glass">
                    <h2>🔗 Relational Intelligence Patterns</h2>
                    
                    <div class="shared-patterns">
                        <h3>🤝 Shared Intelligence Patterns</h3>
                        <p>Where these life forms unite in consciousness:</p>
                        <div class="pattern-list">
                            <div style="margin-bottom: 15px;">
                                <strong style="color: #E0E7FF;">PERCEIVE:</strong> ${sharedPatterns.perceive.join(' • ')}
                            </div>
                            <div style="margin-bottom: 15px;">
                                <strong style="color: #E0E7FF;">RELATE:</strong> ${sharedPatterns.relate.join(' • ')}
                            </div>
                            <div>
                                <strong style="color: #E0E7FF;">APPLY:</strong> ${sharedPatterns.apply.join(' • ')}
                            </div>
                        </div>
                    </div>
                    
                    <div class="unique-expressions">
                        <h3>✨ Unique Intelligence Expressions</h3>
                        <p>Where each life form offers irreplaceable gifts:</p>
                        ${speciesNames.map(species => `
                            <div class="species-comparison">
                                <h4>${species}</h4>
                                <div><strong>Perceive:</strong> ${uniqueTraits[species].perceive}</div>
                                <div><strong>Relate:</strong> ${uniqueTraits[species].relate}</div>
                                <div><strong>Apply:</strong> ${uniqueTraits[species].apply}</div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="collective-wisdom">
                        <h3>🌐 Collective Intelligence Wisdom</h3>
                        <p>Together, these ${speciesNames.length} life forms demonstrate that intelligence is not a hierarchy but a symphony. Each contributes irreplaceable notes to the greater composition of planetary consciousness. Human intelligence finds its highest expression not in dominance, but in recognizing and honoring the unique gifts that each form of life brings to our shared evolutionary journey.</p>
                    </div>
                </div>
            `;
        }

        // Usage tracking functions
        function updateUsageDisplay() {
            const today = new Date().toDateString();
            const todayUsage = dailyUsage[today] || 0;
            const remaining = CONFIG.DAILY_SEARCH_LIMIT - todayUsage;
            const budgetPercent = (monthlySpend / CONFIG.MONTHLY_BUDGET * 100).toFixed(1);
            
            document.getElementById('usageDisplay').innerHTML = `
                Searches today: ${todayUsage}/${CONFIG.DAILY_SEARCH_LIMIT} | 
                Monthly budget: ${budgetPercent}% of ${CONFIG.MONTHLY_BUDGET}
            `;
        }

        // 3D Constellation functions
        function initializeConstellation() {
            const canvas = document.getElementById('constellationCanvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            const container = document.getElementById('constellationContainer');
            canvas.width = container.offsetWidth;
            canvas.height = 400;
            
            // Initial empty state
            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Species Constellation will appear here after research', canvas.width/2, canvas.height/2);
        }

        function updateConstellation(speciesData) {
            const container = document.getElementById('constellationContainer');
            const canvas = document.getElementById('constellationCanvas');
            const ctx = canvas.getContext('2d');
            
            // Show constellation
            container.style.display = 'block';
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Set canvas size
            canvas.width = container.offsetWidth;
            canvas.height = 400;
            
            // Draw constellation
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(canvas.width, canvas.height) / 3;
            
            speciesData.forEach((species, index) => {
                const angle = (index / speciesData.length) * 2 * Math.PI;
                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius;
                
                // Draw connections to center
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                // Draw species node
                ctx.beginPath();
                ctx.arc(x, y, 8, 0, 2 * Math.PI);
                ctx.fill();
                
                // Draw species name
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(species.species, x, y + 25);
            });
            
            // Draw center node
            ctx.beginPath();
            ctx.arc(centerX, centerY, 12, 0, 2 * Math.PI);
            ctx.fillStyle = 'rgba(255, 215, 0, 0.8)';
            ctx.fill();
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.font = '14px Arial';
            ctx.fillText('Planetary', centerX, centerY - 5);
            ctx.fillText('Intelligence', centerX, centerY + 10);
        }

        // Utility functions
        function resetSearch() {
            document.getElementById('species1').value = '';
            document.getElementById('species2').value = '';
            document.getElementById('species3').value = '';
            document.getElementById('species4').value = '';
            document.getElementById('species5').value = '';
            document.getElementById('includeIndigenous').checked = false;
            document.getElementById('includeBiomimicry').checked = false;
            document.getElementById('includeHuman').checked = false;
            document.getElementById('results').innerHTML = '';
            document.getElementById('constellationContainer').style.display = 'none';
            document.getElementById('species1').focus();
        }

        function generatePDFReport() {
            if (!currentSpeciesData || currentSpeciesData.length === 0) {
                alert('No species data available for PDF generation.');
                return;
            }
            
            // For now, show a placeholder - will implement full PDF generation
            alert('PDF generation coming soon! For now, you can copy and paste the research results.');
        }

        function showContributionForm() {
            document.getElementById('contributionModal').style.display = 'block';
        }

        function closeContributionModal() {
            document.getElementById('contributionModal').style.display = 'none';
        }

        // Community contribution handling
        document.getElementById('contributionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // Basic validation
            if (data.contributorName.length < 2 || data.contributorEmail.length < 5) {
                alert('Please provide valid name and email.');
                return;
            }
            
            if (data.sources.split('\n').filter(s => s.trim().length > 10).length < 2) {
                alert('Please provide at least 2 detailed sources.');
                return;
            }
            
            try {
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.textContent = 'Submitting...';
                submitBtn.disabled = true;
                
                // Submit to Netlify function
                const response = await fetch('/.netlify/functions/submit-contribution', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert('Thank you! Your contribution has been submitted for review. You will receive a confirmation email shortly.');
                    closeContributionModal();
                    e.target.reset();
                } else {
                    throw new Error('Submission failed');
                }
                
            } catch (error) {
                alert('Error submitting contribution. Please try again or contact info@kerrilake.com');
            } finally {
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.textContent = 'Submit Contribution';
                submitBtn.disabled = false;
            }
        });

        // Budget notification (placeholder - would integrate with email service)
        async function sendBudgetNotification(currentSpend) {
            const percent = (currentSpend / CONFIG.MONTHLY_BUDGET * 100).toFixed(1);
            console.log(`Budget notification: ${percent}% of monthly budget used (${currentSpend.toFixed(2)})`);
            
            // In production, this would send an email to info@kerrilake.com
            try {
                await fetch('/.netlify/functions/budget-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        currentSpend: currentSpend,
                        budgetPercent: percent,
                        monthlyBudget: CONFIG.MONTHLY_BUDGET
                    })
                });
            } catch (error) {
                console.error('Failed to send budget notification:', error);
            }
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('contributionModal');
            if (event.target === modal) {
                closeContributionModal();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeContributionModal();
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                conductResearch();
            }
        });

        console.log('🧬 Species Intelligence Research Agent loaded successfully!');
        console.log('🌍 Ready to explore the intelligence of all life forms through the Perceive • Relate • Apply framework');
        console.log('✨ Enhanced with AI integration, community wisdom, and 3D constellation mapping');
    </script>
</body>
</html>
