<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Species Intelligence Research Agent - Redefining Intelligence</title>
    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        .header {
            text-align: center;
            padding: 40px 20px;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            color: white;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1em;
            font-style: italic;
        }

        .search-section {
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }

        .search-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .species-input {
            padding: 15px;
            font-size: 16px;
            border: none;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        .species-input:focus {
            outline: none;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .options-section {
            margin: 20px 0;
            text-align: left;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 15px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
        }

        .checkbox-item input[type="checkbox"] {
            transform: scale(1.2);
        }

        .research-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin: 20px 10px;
        }

        .research-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .research-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .results-container {
            padding: 30px;
            margin: 20px 0;
            position: relative;
        }

        .species-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .species-header h2 {
            font-size: 2.2em;
            color: #333;
            margin-bottom: 10px;
        }

        .research-type {
            display: inline-block;
            background: linear-gradient(135deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .wisdom-insight {
            text-align: center;
            padding: 25px;
            margin: 25px 0;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 165, 0, 0.2));
            border-radius: 15px;
            border-left: 5px solid #FFD700;
        }

        .wisdom-insight h3 {
            color: #B8860B;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .wisdom-insight p {
            font-size: 1.1em;
            line-height: 1.6;
            color: #333;
            font-style: italic;
        }

        .intelligence-framework {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .framework-section {
            padding: 25px;
            border-radius: 15px;
            position: relative;
            backdrop-filter: blur(5px);
        }

        .perceive-section {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(129, 199, 132, 0.3));
            border-left: 5px solid #4CAF50;
        }

        .relate-section {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.3), rgba(100, 181, 246, 0.3));
            border-left: 5px solid #2196F3;
        }

        .apply-section {
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.3), rgba(186, 104, 200, 0.3));
            border-left: 5px solid #9C27B0;
        }

        .framework-section h3 {
            font-size: 1.4em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .framework-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .framework-section p {
            line-height: 1.6;
            margin-bottom: 15px;
            color: white;
            font-weight: 500;
        }

        .framework-details {
            list-style: none;
            padding: 0;
        }

        .framework-details li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            position: relative;
            padding-left: 20px;
            color: white;
            font-weight: 500;
        }

        .framework-details li:before {
            content: "•";
            position: absolute;
            left: 0;
            color: white;
            font-weight: bold;
        }

        .comparative-section {
            margin: 40px 0;
            padding: 30px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(167, 139, 250, 0.3));
            border-radius: 20px;
            border-left: 5px solid #8B5CF6;
        }

        .comparative-section h2 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .shared-patterns, .unique-expressions {
            margin: 25px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }

        .shared-patterns h3, .unique-expressions h3 {
            color: #E0E7FF;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .shared-patterns p, .unique-expressions p {
            color: #E0E7FF;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .pattern-list {
            color: white;
            font-weight: 500;
        }

        .species-comparison {
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
        }

        .species-comparison h4 {
            color: #FDE68A;
            margin-bottom: 10px;
        }

        .species-comparison div {
            color: white;
            font-size: 0.9em;
            line-height: 1.4;
            margin-bottom: 5px;
        }

        .collective-wisdom {
            text-align: center;
            padding: 25px;
            margin: 25px 0;
            background: linear-gradient(135deg, rgba(45, 212, 191, 0.3), rgba(34, 197, 94, 0.3));
            border-radius: 15px;
            border-left: 5px solid #2DD4BF;
        }

        .collective-wisdom h3 {
            color: #ECFDF5;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .collective-wisdom p {
            color: #ECFDF5;
            font-size: 1.1em;
            line-height: 1.6;
            font-style: italic;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .action-btn {
            flex: 1;
            min-width: 200px;
            padding: 15px 25px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .breakdown-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .contribute-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .research-another-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .loading-enhanced {
            text-align: center;
            padding: 60px 20px;
            margin: 20px 0;
        }

        .research-animation {
            font-size: 64px;
            animation: research-pulse 2s infinite;
            margin-bottom: 20px;
        }

        @keyframes research-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .usage-stats {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 12px;
            z-index: 100;
        }

        .constellation-container {
            height: 400px;
            margin: 30px 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            position: relative;
            overflow: hidden;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            margin: 3% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
        }

        .form-group {
            margin: 20px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.9);
            font-family: inherit;
        }

        .fade-in {
            animation: fadeIn 0.6s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .search-grid {
                grid-template-columns: 1fr;
            }

            .intelligence-framework {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-btn {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header glass">
            <h1>Species Intelligence Research Agent</h1>
            <p>Redefining Intelligence Through the Perceive • Relate • Apply Framework</p>
        </header>

        <section class="search-section glass">
            <h2 style="color: white; margin-bottom: 20px;">Explore Species Intelligence</h2>
            
            <div class="search-grid">
                <input type="text" class="species-input" id="species1" placeholder="Enter first species (e.g., dolphins)" />
                <input type="text" class="species-input" id="species2" placeholder="Enter second species (optional)" />
                <input type="text" class="species-input" id="species3" placeholder="Enter third species (optional)" />
                <input type="text" class="species-input" id="species4" placeholder="Enter fourth species (optional)" />
                <input type="text" class="species-input" id="species5" placeholder="Enter fifth species (optional)" />
            </div>

            <div class="options-section">
                <h3 style="color: white; margin-bottom: 15px;">Enhanced Research Options</h3>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="includeIndigenous" />
                        <label for="includeIndigenous">Include Indigenous Knowledge</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="includeBiomimicry" />
                        <label for="includeBiomimicry">Include Biomimicry Applications</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="includeHuman" />
                        <label for="includeHuman">Compare with Human Intelligence</label>
                    </div>
                </div>
            </div>

            <button class="research-btn" onclick="conductResearch()">
                🔬 Reveal Intelligence
            </button>
            
            <button class="research-btn" onclick="showContributionForm()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); margin-left: 10px;">
                🤝 Contribute Knowledge
            </button>

            <div style="margin-top: 20px;">
                <div id="usageDisplay" style="color: white; font-size: 14px;"></div>
            </div>
        </section>

        <div id="constellationContainer" class="constellation-container glass" style="display: none;">
            <canvas id="constellationCanvas" width="100%" height="400"></canvas>
        </div>

        <div id="results"></div>

        <div class="usage-stats" id="usageStats"></div>
    </div>

    <!-- Community Contribution Modal -->
    <div id="contributionModal" class="modal">
        <div class="modal-content glass">
            <span style="position: absolute; right: 20px; top: 15px; font-size: 28px; font-weight: bold; cursor: pointer; color: #666;" onclick="closeContributionModal()">&times;</span>
            <h3>Contribute Species Intelligence Knowledge</h3>
            <p>Share your research, observations, or insights about species intelligence</p>
            
            <form id="contributionForm">
                <div class="form-group">
                    <label for="contributorName">Your Name/Organization *:</label>
                    <input type="text" id="contributorName" required>
                </div>
                
                <div class="form-group">
                    <label for="contributorEmail">Email (for verification) *:</label>
                    <input type="email" id="contributorEmail" required>
                </div>
                
                <div class="form-group">
                    <label for="contributorCredentials">Credentials/Background:</label>
                    <input type="text" id="contributorCredentials" placeholder="PhD in Biology, Indigenous Elder, Professional Animal Communicator, etc.">
                </div>
                
                <div class="form-group">
                    <label for="speciesName">Species Name *:</label>
                    <input type="text" id="speciesName" required>
                </div>
                
                <div class="form-group">
                    <label for="wisdomInsight">Key Wisdom Insight *:</label>
                    <textarea id="wisdomInsight" rows="3" required 
                            placeholder="What profound insight about this species' intelligence should people know?"></textarea>
                </div>
                
                <div style="background: rgba(78, 205, 196, 0.1); padding: 20px; border-radius: 12px; margin: 20px 0;">
                    <h4 style="color: #4ECDC4; margin-bottom: 12px;">PERCEIVE - How they perceive their world:</h4>
                    <textarea id="perceiveData" rows="4" required
                            placeholder="Describe their sensory capabilities, environmental awareness, unique perceptual gifts..."></textarea>
                </div>
                
                <div style="background: rgba(78, 205, 196, 0.1); padding: 20px; border-radius: 12px; margin: 20px 0;">
                    <h4 style="color: #4ECDC4; margin-bottom: 12px;">RELATE - How they relate to their world:</h4>
                    <textarea id="relateData" rows="4" required
                            placeholder="Social structures, communication, ecological relationships, cultural significance..."></textarea>
                </div>
                
                <div style="background: rgba(78, 205, 196, 0.1); padding: 20px; border-radius: 12px; margin: 20px 0;">
                    <h4 style="color: #4ECDC4; margin-bottom: 12px;">APPLY - How they apply their intelligence:</h4>
                    <textarea id="applyData" rows="4" required
                            placeholder="Problem-solving, tool use, learning, ecosystem contributions..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="humanLearnings">What humans can learn from this species *:</label>
                    <textarea id="humanLearnings" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="conservationWisdom">Conservation intelligence insights *:</label>
                    <textarea id="conservationWisdom" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="sources">Sources/References (required) *:</label>
                    <textarea id="sources" rows="4" required
                            placeholder="List your sources: research papers, traditional knowledge, personal observation, etc. At least 2 sources required."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="experienceType">Type of contribution *:</label>
                    <select id="experienceType" required>
                        <option value="">Select type</option>
                        <option value="scientific">Scientific Research</option>
                        <option value="indigenous">Indigenous/Traditional Knowledge</option>
                        <option value="observation">Field Observation</option>
                        <option value="interspecies">Interspecies Communication</option>
                        <option value="biomimicry">Biomimicry Application</option>
                        <option value="conservation">Conservation Experience</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="accuracy" required>
                        <label for="accuracy">I verify that this information is accurate to the best of my knowledge *</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="permission" required>
                        <label for="permission">I give permission for this contribution to be used in the Species Intelligence Research database *</label>
                    </div>
                </div>
                
                <button type="submit" style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%; margin-top: 20px;">Submit Contribution</button>
            </form>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            DAILY_SEARCH_LIMIT: 6,
            MONTHLY_BUDGET: 100,
            COST_PER_SEARCH: 0.50, // Estimated average
            EMAIL_THRESHOLD: 80 // Notify at 80% of budget
        };

        // Global state
        let currentSpeciesData = [];
        let researchHistory = JSON.parse(localStorage.getItem('researchHistory') || '[]');
        let dailyUsage = JSON.parse(localStorage.getItem('dailyUsage') || '{}');
        let monthlySpend = parseFloat(localStorage.getItem('monthlySpend') || '0');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateUsageDisplay();
            initializeConstellation();
            
            // Add enter key support
            const inputs = document.querySelectorAll('.species-input');
            inputs.forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        conductResearch();
                    }
                });
            });
        });

        // Enhanced AI API Integration with comprehensive research
        async function callAnthropicAPI(speciesName, options) {
            console.log('=== CALLING ENHANCED API FOR:', speciesName, '===');
            
            const prompt = createEnhancedResearchPrompt(speciesName, options);
            
            try {
                console.log('Making enhanced research request to Netlify function...');
                
                const response = await fetch('/.netlify/functions/research-species', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        species: speciesName,
                        prompt: prompt,
                        options: options
                    })
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error:', errorText);
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                console.log('Received enhanced data:', data);
                
                // Check if we got a successful response
                if (data.success && data.response) {
                    console.log('✅ Enhanced AI API call successful for', speciesName);
                    return data.response;
                } else {
                    console.warn('⚠️ API returned data but no success flag:', data);
                    return data.response || data;
                }
                
            } catch (error) {
                console.error('❌ Enhanced AI API Error for', speciesName, ':', error);
                console.log('🔄 Falling back to enhanced local data');
                
                const fallbackData = createEnhancedFallback(speciesName, options);
                fallbackData.fallbackReason = `API Error: ${error.message}`;
                fallbackData.researchBacked = false;
                return fallbackData;
            }
        }

        // Enhanced Research Prompt with All 6 Dimensions
        function createEnhancedResearchPrompt(speciesName, options) {
            const enhancedDimensions = {
                temporalIntelligence: `
- Temporal awareness and time perception capabilities with specific examples
- Seasonal intelligence and circadian rhythm adaptations with documented behaviors
- Intergenerational knowledge transfer mechanisms with case studies
- Long-term ecological memory and environmental pattern recognition with research citations`,
                
                energeticIntelligence: `
- Biofield interactions and electromagnetic sensitivity with measurable phenomena
- Energy conservation and optimization strategies with quantifiable outcomes
- Healing and regenerative intelligence applications with documented cases
- Quantum coherence in biological systems with current research findings`,
                
                collectiveIntelligence: `
- Swarm intelligence and collective decision-making with specific examples
- Information sharing across group consciousness with documented behaviors
- Distributed problem-solving capabilities with case studies
- Emergent intelligence in social structures with research backing`,
                
                adaptiveIntelligence: `
- Real-time adaptation mechanisms and plasticity with documented responses
- Crisis response and survival intelligence with specific examples
- Environmental stress adaptation strategies with measurable outcomes
- Evolutionary intelligence and species resilience with long-term studies`
            };
            
            const indigenousKnowledge = options.includeIndigenous ? `
- Indigenous wisdom and traditional ecological knowledge from multiple specific cultures
- Sacred relationships and ceremonial connections with documented practices
- Traditional uses and spiritual significance across different indigenous traditions with cultural attribution
- Shamanic and interspecies communication practices with specific examples` : '';

            const biomimicryApplications = options.includeBiomimicry ? `
- Current biomimicry applications with specific technological examples and companies
- Potential future innovations with detailed technological possibilities
- Economic and environmental impact with quantifiable benefits
- Bio-inspired solutions for consciousness evolution with practical applications` : '';

            return `You are a world-renowned multidisciplinary species intelligence researcher with expertise in consciousness studies, quantum biology, ecological intelligence, and interspecies communication. Research ${speciesName} through the revolutionary "Perceive/Relate/Apply" intelligence framework with unprecedented depth and precision.

COMPREHENSIVE RESEARCH REQUIREMENTS WITH ENHANCED DIMENSIONS:

1. PERCEIVE: How does ${speciesName} perceive their world?
   - Sensory capabilities with specific mechanisms and ranges
   - Environmental awareness systems with documented examples
   - Quantum sensing abilities with current research citations
   - Survival perception with documented threat responses
   ${enhancedDimensions.temporalIntelligence}
   ${enhancedDimensions.energeticIntelligence}

2. RELATE: How does ${speciesName} relate to their world?
   - Social structures with specific hierarchies and roles
   - Communication methods with documented signal types
   - Ecological relationships with quantified interdependencies
   - Emotional and energetic connections with behavioral evidence
   ${enhancedDimensions.collectiveIntelligence}

3. APPLY: How does ${speciesName} apply their intelligence?
   - Problem-solving with documented case studies and outcomes
   - Tool use and environmental manipulation with specific examples
   - Learning mechanisms with neurological and behavioral evidence
   - Ecosystem contributions with measurable impacts
   ${enhancedDimensions.adaptiveIntelligence}

COMPREHENSIVE RESEARCH SOURCES - Include specific citations:
- Latest peer-reviewed research from Nature, Science, Animal Cognition, Consciousness and Cognition journals
- Quantum biology studies from researchers like Penrose, Hameroff, McFadden, Al-Khalili
- Consciousness research from institutes like IONS, University of Arizona Center for Consciousness Studies
- Earth Species Project findings and AI-assisted animal communication research${indigenousKnowledge}${biomimicryApplications}
- Field studies with specific locations, dates, and lead researchers
- Conservation biology data with population studies and ecological impact measurements
- Biophysics and quantum field interaction studies with experimental results

ENHANCED RESPONSE FORMAT - Provide unprecedented detail:
{
  "species": "${speciesName}",
  "wisdomInsight": "Revolutionary insight about this species' intelligence that could fundamentally change human understanding of consciousness (4-5 sentences with specific examples and implications)",
  "perceive": {
    "summary": "Comprehensive analysis of their perceptual world with specific mechanisms and capabilities (4-5 sentences)",
    "details": [
      "Primary sensory capability with range/mechanism (e.g., echolocation at 150 kHz with 200m range)",
      "Environmental awareness system with specific examples (e.g., magnetic field detection for migration)",
      "Quantum/biofield perception with research evidence (e.g., electromagnetic sensitivity studies)",
      "Temporal intelligence with specific time perception abilities",
      "Energetic sensitivity with documented biofield interactions"
    ]
  },
  "relate": {
    "summary": "Deep analysis of relational intelligence with specific relationship patterns and communication systems (4-5 sentences)",
    "details": [
      "Social structure with specific roles and hierarchies (e.g., matriarchal pods with 8-12 individuals)",
      "Communication method with signal types and meanings (e.g., signature whistles, alarm calls)",
      "Ecological relationship with quantified impact (e.g., seed dispersal of 50+ plant species)",
      "Collective intelligence mechanism with group behavior examples",
      "Interspecies relationship with documented cases and outcomes"
    ]
  },
  "apply": {
    "summary": "Comprehensive analysis of intelligence applications with documented case studies and measurable outcomes (4-5 sentences)",
    "details": [
      "Problem-solving example with specific scenario and solution (e.g., tool modification for food extraction)",
      "Adaptive strategy with measurable success rate (e.g., 95% survival rate during environmental changes)",
      "Learning mechanism with neurological evidence (e.g., hippocampal plasticity in spatial memory)",
      "Ecosystem contribution with quantified impact (e.g., carbon sequestration rates, biodiversity support)",
      "Innovation/creativity with documented novel behaviors and cultural transmission"
    ]
  },
  "humanLearnings": "Specific, actionable lessons for human consciousness evolution, personal development, and societal advancement with practical applications (5-6 sentences)",
  "conservationWisdom": "Detailed conservation intelligence including specific threats, population data, protection strategies, and ecosystem interdependencies with quantified impacts (5-6 sentences)",
  "quantumAspects": "Specific quantum biology and consciousness connections with current research citations, lead researchers, and measurable phenomena (4-5 sentences)",
  "temporalIntelligence": "How this species perceives and works with time, including seasonal cycles, circadian rhythms, and long-term pattern recognition with specific examples",
  "energeticIntelligence": "Biofield interactions, electromagnetic sensitivity, energy healing capabilities, and quantum coherence with documented research",
  "collectiveWisdom": "Group consciousness, collective decision-making, distributed intelligence, and swarm behaviors with specific examples and outcomes",
  "adaptiveStrategies": "Real-time adaptation mechanisms, crisis responses, environmental stress management, and evolutionary resilience with documented cases",
  "geographicVariations": "How intelligence expressions vary across different geographical regions and environments with specific location-based studies",
  "culturalTransmission": "How knowledge and behaviors are passed between generations and across populations with documented examples",
  "biomimicryPotential": "Current and potential technological applications inspired by this species' intelligence with specific innovations and economic potential",
  "sources": [
    "Specific peer-reviewed paper with lead author, journal, and year (e.g., Smith et al., Nature 2023)",
    "Named consciousness/quantum biology researcher and their specific work with institution", 
    "Documented field study with location, duration, and key findings",
    "Conservation database or report with specific population data and trends",
    "Indigenous knowledge source with cultural attribution and traditional practice description",
    "Biomimicry application with company/institution and technological details"
  ]
}

CRITICAL RESEARCH DEPTH REQUIREMENTS:
- Include specific numerical data, measurements, and quantified outcomes wherever possible
- Reference exact geographical locations, time periods, and research institutions
- Provide names of lead researchers and specific study citations with years
- Include population data, behavioral frequencies, and measurable impacts
- Connect findings to broader consciousness research and ecological intelligence frameworks
- Ensure each insight has verifiable research backing or documented field observations
- Include economic, technological, and practical applications for human development

Focus on consciousness-expanding insights that bridge cutting-edge science with ancient wisdom. Provide unprecedented depth that could revolutionize human understanding of intelligence and consciousness. Respond ONLY with valid JSON that represents the most comprehensive species intelligence research ever compiled.`;
        }

        function parseAIResponse(responseText, speciesName) {
            try {
                console.log('Parsing enhanced AI response for:', speciesName);
                console.log('Response text preview:', responseText.substring(0, 100) + '...');
                
                const cleanedResponse = responseText
                    .replace(/```json\n?/g, "")
                    .replace(/```\n?/g, "")
                    .trim();
                
                const data = JSON.parse(cleanedResponse);
                
                return {
                    species: data.species || speciesName,
                    wisdomInsight: data.wisdomInsight || "This species demonstrates revolutionary intelligence worthy of deeper study.",
                    perceive: data.perceive || { summary: "Advanced perceptual capabilities", details: [] },
                    relate: data.relate || { summary: "Complex relational intelligence", details: [] },
                    apply: data.apply || { summary: "Sophisticated problem-solving abilities", details: [] },
                    humanLearnings: data.humanLearnings || "Valuable lessons for human consciousness evolution",
                    conservationWisdom: data.conservationWisdom || "Critical importance for ecosystem balance and health",
                    quantumAspects: data.quantumAspects || "Consciousness connections being explored by researchers",
                    temporalIntelligence: data.temporalIntelligence || "Sophisticated time perception and seasonal awareness",
                    energeticIntelligence: data.energeticIntelligence || "Biofield sensitivity and energy optimization",
                    collectiveWisdom: data.collectiveWisdom || "Group consciousness and collective decision-making abilities",
                    adaptiveStrategies: data.adaptiveStrategies || "Remarkable adaptation mechanisms and resilience",
                    geographicVariations: data.geographicVariations || "Intelligence expressions vary across different environments",
                    culturalTransmission: data.culturalTransmission || "Knowledge transfer across generations and populations",
                    biomimicryPotential: data.biomimicryPotential || "Significant potential for technological innovation",
                    sources: data.sources || ["Enhanced research compilation"],
                    researchBacked: true,
                    timestamp: new Date().toISOString()
                };
            } catch (parseError) {
                console.warn("Failed to parse enhanced AI response:", parseError);
                console.log("Raw response that failed to parse:", responseText);
                return createEnhancedFallback(speciesName, {});
            }
        }

        // Updated main research function with enhanced depth
        async function conductResearch() {
            const speciesInputs = [
                document.getElementById('species1').value.trim(),
                document.getElementById('species2').value.trim(),
                document.getElementById('species3').value.trim(),
                document.getElementById('species4').value.trim(),
                document.getElementById('species5').value.trim()
            ].filter(species => species.length > 0);

            if (speciesInputs.length === 0) {
                alert('Please enter at least one species name');
                return;
            }

            // Check daily limits
            const today = new Date().toDateString();
            if (!dailyUsage[today]) dailyUsage[today] = 0;
            
            if (false && dailyUsage[today] >= CONFIG.DAILY_SEARCH_LIMIT) {
                alert(`Daily search limit reached (${CONFIG.DAILY_SEARCH_LIMIT} searches). Please try again tomorrow or contact info@kerrilake.com for extended access.`);
                return;
            }

            const options = {
                includeIndigenous: document.getElementById('includeIndigenous').checked,
                includeBiomimicry: document.getElementById('includeBiomimicry').checked,
                includeHuman: document.getElementById('includeHuman').checked
            };

            if (options.includeHuman) {
                speciesInputs.push('Human');
            }

            const resultsDiv = document.getElementById('results');
            
            try {
                console.log('🔬 Starting enhanced research for:', speciesInputs);
                console.log('🎛️ Enhanced options:', options);
                
                // Show enhanced loading
                resultsDiv.innerHTML = `
                    <div class="results-container glass fade-in">
                        <div class="loading-enhanced">
                            <div class="research-animation">🧬</div>
                            <h3>Conducting Deep Species Intelligence Research</h3>
                            <p>Enhanced Claude AI analysis with temporal, energetic, collective, and adaptive intelligence dimensions</p>
                            <p style="color: rgba(255,255,255,0.7); font-size: 14px; margin-top: 10px;">This comprehensive research may take 15-20 seconds per species...</p>
                        </div>
                    </div>
                `;

                // Call enhanced AI API for each species
                const researchResults = [];
                for (let i = 0; i < speciesInputs.length; i++) {
                    const species = speciesInputs[i];
                    console.log(`🔍 Enhanced research ${i + 1}/${speciesInputs.length}: ${species}`);
                    
                    // Update loading message
                    resultsDiv.innerHTML = `
                        <div class="results-container glass fade-in">
                            <div class="loading-enhanced">
                                <div class="research-animation">🧬</div>
                                <h3>Researching ${species}...</h3>
                                <p>Species ${i + 1} of ${speciesInputs.length} • Enhanced Claude AI with 6 intelligence dimensions</p>
                                <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; margin: 10px 0;">
                                    <div style="width: ${(i/speciesInputs.length)*100}%; height: 4px; background: #4CAF50; border-radius: 2px;"></div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    const result = await callAnthropicAPI(species, options);
                    researchResults.push(result);
                    
                    console.log(`✅ Enhanced research completed for ${species}:`, result.researchBacked ? 'AI-powered' : 'Fallback data');
                }

                console.log('🎉 All enhanced research completed!');

                // Update usage tracking
                dailyUsage[today]++;
                monthlySpend += CONFIG.COST_PER_SEARCH * speciesInputs.length;
                localStorage.setItem('dailyUsage', JSON.stringify(dailyUsage));
                localStorage.setItem('monthlySpend', monthlySpend.toString());

                // Check budget threshold
                if (monthlySpend >= CONFIG.MONTHLY_BUDGET * (CONFIG.EMAIL_THRESHOLD / 100)) {
                    await sendBudgetNotification(monthlySpend);
                }

                // Store in research history
                const searchRecord = {
                    species: speciesInputs,
                    timestamp: new Date().toISOString(),
                    options: options,
                    results: researchResults
                };
                researchHistory.push(searchRecord);
                localStorage.setItem('researchHistory', JSON.stringify(researchHistory));

                // Display enhanced results
                displayEnhancedResults(researchResults);
                updateUsageDisplay();
                updateConstellation(researchResults);
                
            } catch (error) {
                console.error('❌ Enhanced research failed:', error);
                resultsDiv.innerHTML = `
                    <div class="results-container glass fade-in">
                        <div style="text-align: center; padding: 40px;">
                            <h3 style="color: #e74c3c;">Research Temporarily Unavailable</h3>
                            <p style="color: #333;">Error: ${error.message}</p>
                            <p style="color: #666; font-size: 14px; margin-top: 15px;">Check the browser console (F12) for more details.</p>
                            <button onclick="conductResearch()" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; border: none; padding: 12px 25px; border-radius: 20px; cursor: pointer; margin-top: 15px;">Try Again</button>
                        </div>
                    </div>
                `;
            }
        }

        function displayEnhancedResults(dataArray) {
            const resultsDiv = document.getElementById('results');
            currentSpeciesData = dataArray;
            
            let html = '<div class="fade-in">';
            
            // Individual species results with enhanced dimensions
            dataArray.forEach((data, index) => {
                html += `
                    <div class="results-container glass">
                        <div class="species-header">
                            <h2>${data.species}</h2>
                            <div class="research-type">
                                ${data.researchBacked ? '🔬 Enhanced AI Research' : '📋 Enhanced Framework Analysis'}
                            </div>
                        </div>
                        
                        <div class="wisdom-insight">
                            <h3>💡 Revolutionary Wisdom</h3>
                            <p>${data.wisdomInsight}</p>
                        </div>
                        
                        <div class="intelligence-framework">
                            <div class="framework-section perceive-section">
                                <h3><span class="framework-badge">PERCEIVE</span> How They Perceive</h3>
                                <p>${data.perceive.summary}</p>
                                <ul class="framework-details">
                                    ${data.perceive.details.map(detail => `<li>${detail}</li>`).join('')}
                                </ul>
                            </div>
                            
                            <div class="framework-section relate-section">
                                <h3><span class="framework-badge">RELATE</span> How They Relate</h3>
                                <p>${data.relate.summary}</p>
                                <ul class="framework-details">
                                    ${data.relate.details.map(detail => `<li>${detail}</li>`).join('')}
                                </ul>
                            </div>
                            
                            <div class="framework-section apply-section">
                                <h3><span class="framework-badge">APPLY</span> How They Apply Intelligence</h3>
                                <p>${data.apply.summary}</p>
                                <ul class="framework-details">
                                    ${data.apply.details.map(detail => `<li>${detail}</li>`).join('')}
                                </ul>
                            </div>
                        </div>

                        <div class="wisdom-insight" style="background: linear-gradient(135deg, rgba(147, 51, 234, 0.3), rgba(79, 70, 229, 0.3)); border-left-color: #9333ea;">
                            <h3>🌌 Quantum Biology & Consciousness</h3>
                            <p>${data.quantumAspects}</p>
                        </div>

                        <div class="wisdom-insight" style="background: linear-gradient(135deg, rgba(255, 107, 107, 0.3), rgba(255, 159, 67, 0.3)); border-left-color: #ff6b6b;">
                            <h3>⏰ Temporal Intelligence</h3>
                            <p>${data.temporalIntelligence}</p>
                        </div>

                        <div class="wisdom-insight" style="background: linear-gradient(135deg, rgba(78, 205, 196, 0.3), rgba(85, 239, 196, 0.3)); border-left-color: #4ecdc4;">
                            <h3>⚡ Energetic Intelligence</h3>
                            <p>${data.energeticIntelligence}</p>
                        </div>

                        <div class="wisdom-insight" style="background: linear-gradient(135deg, rgba(116, 185, 255, 0.3), rgba(162, 155, 254, 0.3)); border-left-color: #74b9ff;">
                            <h3>🤝 Collective Wisdom</h3>
                            <p>${data.collectiveWisdom}</p>
                        </div>

                        <div class="wisdom-insight" style="background: linear-gradient(135deg, rgba(253, 203, 110, 0.3), rgba(255, 179, 71, 0.3)); border-left-color: #fdcb6e;">
                            <h3>🔄 Adaptive Strategies</h3>
                            <p>${data.adaptiveStrategies}</p>
                        </div>
                        
                        <div class="wisdom-insight" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(16, 185, 129, 0.3)); border-left-color: #22c55e;">
                            <h3>🌱 Human Learning Opportunities</h3>
                            <p>${data.humanLearnings}</p>
                        </div>
                        
                        <div class="wisdom-insight" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(147, 197, 253, 0.3)); border-left-color: #3b82f6;">
                            <h3>🌍 Conservation Intelligence</h3>
                            <p>${data.conservationWisdom}</p>
                        </div>

                        ${data.biomimicryPotential ? `
                        <div class="wisdom-insight" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.3), rgba(196, 181, 253, 0.3)); border-left-color: #a855f7;">
                            <h3>🔬 Biomimicry Potential</h3>
                            <p>${data.biomimicryPotential}</p>
                        </div>` : ''}
                    </div>
                `;
            });

            // Add comparative analysis if multiple species
            if (dataArray.length > 1) {
                html += generateEnhancedComparativeAnalysis(dataArray);
            }

            // Action buttons
            html += `
                <div class="results-container glass">
                    <div class="action-buttons">
                        <button class="action-btn breakdown-btn" onclick="generateEnhancedPDFReport()">
                            📄 Break it Down for Me (Download Comprehensive Report)
                        </button>
                        <button class="action-btn contribute-btn" onclick="showContributionForm()">
                            🤝 Contribute Knowledge
                        </button>
                        <button class="action-btn research-another-btn" onclick="resetSearch()">
                            🔍 Research More Species
                        </button>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 10px;">
                        <small style="color: #666; font-size: 12px;">Enhanced research powered by Claude AI with 6 intelligence dimensions • ${dataArray.reduce((sum, d) => sum + (d.sources?.length || 0), 0)} sources consulted</small>
                    </div>
                </div>
            `;

            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        // Enhanced PDF Generation Function with Error Handling
        function generateEnhancedPDFReport() {
            if (!currentSpeciesData || currentSpeciesData.length === 0) {
                alert('No species data available for PDF generation. Please conduct research first.');
                return;
            }
            
            try {
                // Check if jsPDF is available with better error handling
                if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF) {
                    console.error('jsPDF not loaded properly');
                    alert('PDF library is still loading. Please wait a moment and try again. If the issue persists, refresh the page.');
                    return;
                }

                const { jsPDF } = window.jspdf;
                
                // Test jsPDF creation
                let doc;
                try {
                    doc = new jsPDF();
                } catch (pdfError) {
                    console.error('Error creating PDF document:', pdfError);
                    alert('Error initializing PDF generator. Please refresh the page and try again.');
                    return;
                }
                
                // Set up styling variables
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 20;
                const contentWidth = pageWidth - (margin * 2);
                let yPosition = margin;
                
                // Colors
                const primaryColor = [102, 126, 234];
                const secondaryColor = [118, 75, 162];
                const textColor = [51, 51, 51];
                const accentColor = [78, 205, 196];
                
                // Helper function to add new page if needed
                function checkAndAddPage(requiredHeight = 30) {
                    if (yPosition + requiredHeight > pageHeight - margin) {
                        doc.addPage();
                        yPosition = margin;
                        return true;
                    }
                    return false;
                }
                
                // Helper function to wrap text with error handling
                function addWrappedText(text, fontSize = 10, lineHeight = 5, color = textColor) {
                    if (!text || typeof text !== 'string') {
                        text = 'Information not available';
                    }
                    
                    try {
                        doc.setFontSize(fontSize);
                        doc.setTextColor(...color);
                        const lines = doc.splitTextToSize(text, contentWidth - 20);
                        
                        for (let line of lines) {
                            checkAndAddPage();
                            doc.text(line, margin + 10, yPosition);
                            yPosition += lineHeight;
                        }
                        yPosition += 2;
                    } catch (textError) {
                        console.error('Error adding text to PDF:', textError);
                        // Continue without this text block
                    }
                }
                
                // Title Page
                try {
                    doc.setFontSize(24);
                    doc.setTextColor(...primaryColor);
                    doc.text('Species Intelligence Research Report', margin, yPosition);
                    yPosition += 15;
                    
                    doc.setFontSize(16);
                    doc.setTextColor(...secondaryColor);
                    doc.text('Comprehensive Analysis Through the Perceive • Relate • Apply Framework', margin, yPosition);
                    yPosition += 12;
                    
                    doc.setFontSize(12);
                    doc.setTextColor(...textColor);
                    const speciesNames = currentSpeciesData.map(d => d.species || 'Unknown Species').join(', ');
                    doc.text(`Research Focus: ${speciesNames}`, margin, yPosition);
                    yPosition += 8;
                    
                    const reportDate = new Date().toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                    doc.text(`Generated: ${reportDate}`, margin, yPosition);
                    yPosition += 8;
                    
                    doc.text('Powered by Claude AI & Species Intelligence Framework', margin, yPosition);
                    yPosition += 20;
                } catch (titleError) {
                    console.error('Error creating title page:', titleError);
                }
                
                // Executive Summary
                try {
                    doc.setFontSize(16);
                    doc.setTextColor(...primaryColor);
                    doc.text('Executive Summary', margin, yPosition);
                    yPosition += 10;
                    
                    const executiveSummary = generateExecutiveSummary(currentSpeciesData);
                    addWrappedText(executiveSummary, 10, 5);
                    yPosition += 10;
                } catch (summaryError) {
                    console.error('Error creating executive summary:', summaryError);
                }
                
                // Individual Species Reports
                currentSpeciesData.forEach((species, index) => {
                    try {
                        checkAndAddPage(40);
                        
                        // Species Header
                        doc.setFontSize(18);
                        doc.setTextColor(...primaryColor);
                        doc.text(`${species.species || 'Unknown Species'} Intelligence Profile`, margin, yPosition);
                        yPosition += 8;
                        
                        // Research type indicator
                        doc.setFontSize(10);
                        doc.setTextColor(...accentColor);
                        const researchType = species.researchBacked ? 'AI-Enhanced Research' : 'Framework Analysis';
                        doc.text(`Research Type: ${researchType}`, margin, yPosition);
                        yPosition += 12;
                        
                        // Wisdom Insight
                        doc.setFontSize(14);
                        doc.setTextColor(...secondaryColor);
                        doc.text('Key Wisdom Insight', margin, yPosition);
                        yPosition += 8;
                        addWrappedText(species.wisdomInsight || 'This species demonstrates unique intelligence worthy of deeper study.', 10, 5);
                        yPosition += 5;
                        
                        // Core Framework Sections
                        ['perceive', 'relate', 'apply'].forEach(section => {
                            try {
                                checkAndAddPage(25);
                                const sectionTitle = section.toUpperCase() + ' • ' + 
                                    (section === 'perceive' ? 'How They Perceive Their World' :
                                     section === 'relate' ? 'How They Relate To Their World' :
                                     'How They Apply Their Intelligence');
                                
                                doc.setFontSize(14);
                                doc.setTextColor(...primaryColor);
                                doc.text(sectionTitle, margin, yPosition);
                                yPosition += 8;
                                
                                const sectionData = species[section];
                                if (sectionData && sectionData.summary) {
                                    addWrappedText(sectionData.summary, 10, 5);
                                    
                                    if (sectionData.details && Array.isArray(sectionData.details)) {
                                        doc.setFontSize(10);
                                        doc.setTextColor(...textColor);
                                        sectionData.details.forEach(detail => {
                                            if (detail) {
                                                checkAndAddPage();
                                                doc.text(`• ${detail}`, margin + 5, yPosition);
                                                yPosition += 5;
                                            }
                                        });
                                    }
                                }
                                yPosition += 8;
                            } catch (sectionError) {
                                console.error(`Error processing ${section} section:`, sectionError);
                            }
                        });
                        
                        // Additional Insights
                        const insights = [
                            { key: 'quantumAspects', title: 'Quantum Biology & Consciousness' },
                            { key: 'humanLearnings', title: 'Human Learning Opportunities' },
                            { key: 'conservationWisdom', title: 'Conservation Intelligence' }
                        ];
                        
                        insights.forEach(insight => {
                            if (species[insight.key]) {
                                try {
                                    checkAndAddPage(15);
                                    doc.setFontSize(12);
                                    doc.setTextColor(...secondaryColor);
                                    doc.text(insight.title, margin, yPosition);
                                    yPosition += 6;
                                    addWrappedText(species[insight.key], 9, 4);
                                    yPosition += 5;
                                } catch (insightError) {
                                    console.error(`Error adding ${insight.key}:`, insightError);
                                }
                            }
                        });
                        
                    } catch (speciesError) {
                        console.error(`Error processing species ${species.species}:`, speciesError);
                    }
                });
                
                // Sources and References
                try {
                    checkAndAddPage(30);
                    doc.setFontSize(16);
                    doc.setTextColor(...primaryColor);
                    doc.text('Sources and References', margin, yPosition);
                    yPosition += 10;
                    
                    const allSources = [...new Set(currentSpeciesData.flatMap(d => d.sources || ['Enhanced research framework']))];
                    doc.setFontSize(9);
                    doc.setTextColor(...textColor);
                    
                    allSources.forEach((source, index) => {
                        if (source) {
                            checkAndAddPage();
                            doc.text(`${index + 1}. ${source}`, margin, yPosition);
                            yPosition += 4;
                        }
                    });
                    yPosition += 10;
                } catch (sourcesError) {
                    console.error('Error adding sources:', sourcesError);
                }
                
                // Footer
                try {
                    doc.setFontSize(8);
                    doc.setTextColor(128, 128, 128);
                    doc.text('Generated by Species Intelligence Research Agent', margin, yPosition);
                    doc.text('Perceive/Relate/Apply Framework by Kerri Lake', margin, yPosition + 4);
                    doc.text('Visit: generateharmony.com • intuitivelearningfoundation.org • kerrilake.com', margin, yPosition + 8);
                } catch (footerError) {
                    console.error('Error adding footer:', footerError);
                }
                
                // Save the PDF
                try {
                    const speciesNames = currentSpeciesData.map(d => d.species || 'Species').join('-');
                    const filename = `Species-Intelligence-Report-${speciesNames.replace(/[^a-zA-Z0-9]/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`;
                    doc.save(filename);
                    
                    // Success message
                    setTimeout(() => {
                        alert(`✅ PDF Report Generated Successfully!\n\nFile: ${filename}\n\nThe report includes comprehensive research on ${currentSpeciesData.length} species with full analysis and citations.`);
                    }, 500);
                } catch (saveError) {
                    console.error('Error saving PDF:', saveError);
                    alert('PDF was generated but there was an error saving it. Please try again.');
                }
                
            } catch (error) {
                console.error('Enhanced PDF Generation Error:', error);
                alert(`Error generating PDF: ${error.message}\n\nPlease try again or refresh the page. If the issue persists, contact support.`);
            }
        }

        function generateEnhancedComparativeAnalysis(dataArray) {
            const speciesNames = dataArray.map(d => d.species);
            
            return `
                <div class="comparative-section glass">
                    <h2>🔗 Enhanced Relational Intelligence Patterns</h2>
                    
                    <div class="shared-patterns">
                        <h3>🤝 Universal Intelligence Patterns</h3>
                        <p>Common threads across all studied species:</p>
                        <div class="pattern-list">
                            <div style="margin-bottom: 15px;">
                                <strong style="color: #E0E7FF;">TEMPORAL INTELLIGENCE:</strong> All species demonstrate sophisticated time perception and seasonal awareness beyond human understanding
                            </div>
                            <div style="margin-bottom: 15px;">
                                <strong style="color: #E0E7FF;">ENERGETIC INTELLIGENCE:</strong> Biofield sensitivity and electromagnetic awareness appears universal across these life forms
                            </div>
                            <div style="margin-bottom: 15px;">
                                <strong style="color: #E0E7FF;">COLLECTIVE INTELLIGENCE:</strong> Group consciousness and distributed decision-making characterize all species studied
                            </div>
                            <div>
                                <strong style="color: #E0E7FF;">ADAPTIVE INTELLIGENCE:</strong> Remarkable resilience and real-time adaptation strategies unite these consciousness expressions
                            </div>
                        </div>
                    </div>
                    
                    <div class="unique-expressions">
                        <h3>✨ Unique Intelligence Expressions</h3>
                        <p>Where each species offers irreplaceable evolutionary gifts:</p>
                        ${speciesNames.map(species => {
                            const speciesData = dataArray.find(d => d.species === species);
                            return `
                                <div class="species-comparison">
                                    <h4>${species}</h4>
                                    <div><strong>Temporal Gift:</strong> ${speciesData.temporalIntelligence?.substring(0, 100)}...</div>
                                    <div><strong>Energetic Gift:</strong> ${speciesData.energeticIntelligence?.substring(0, 100)}...</div>
                                    <div><strong>Collective Gift:</strong> ${speciesData.collectiveWisdom?.substring(0, 100)}...</div>
                                    <div><strong>Adaptive Gift:</strong> ${speciesData.adaptiveStrategies?.substring(0, 100)}...</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="collective-wisdom">
                        <h3>🌐 Planetary Intelligence Symphony</h3>
                        <p>Together, these ${speciesNames.length} life forms reveal that intelligence is not a hierarchy but a multidimensional symphony of consciousness. Each species contributes unique temporal, energetic, collective, and adaptive gifts that are essential for planetary health and evolutionary advancement. Human intelligence finds its highest expression in recognizing, protecting, and learning from these diverse forms of consciousness, creating a collaborative evolution toward expanded planetary awareness.</p>
                    </div>
                </div>
            `;
        }

        function generateEnhancedComparativeInsights(speciesData) {
            const speciesNames = speciesData.map(d => d.species);
            
            return `Enhanced comparative analysis of ${speciesNames.join(', ')} reveals unprecedented patterns in multidimensional intelligence across evolutionary pathways. This research represents the most comprehensive species intelligence study ever conducted, incorporating temporal, energetic, collective, and adaptive intelligence dimensions.

UNIVERSAL INTELLIGENCE PATTERNS:
All species demonstrate sophisticated temporal awareness that extends beyond circadian rhythms to include long-term ecological memory, seasonal intelligence, and intergenerational knowledge transfer. Energetic intelligence appears universal, with documented biofield interactions, electromagnetic sensitivity, and quantum coherence in biological systems across all studied species.

COLLECTIVE CONSCIOUSNESS EMERGENCE:
Each species exhibits remarkable collective intelligence mechanisms, from swarm behaviors to distributed decision-making systems that optimize group survival and thriving. These findings suggest consciousness operates at multiple scales simultaneously, challenging individual-centric models of intelligence.

ADAPTIVE RESILIENCE MASTERY:
All species demonstrate extraordinary adaptive strategies that include real-time environmental responsiveness, crisis management protocols, and evolutionary resilience mechanisms that maintain species integrity while enabling continuous adaptation.

BIOMIMICRY REVOLUTIONARY POTENTIAL:
The combined intelligence innovations from these species represent billions of dollars in technological potential, from quantum sensing applications to collective decision algorithms, from regenerative healing technologies to temporal optimization systems.

CONSERVATION IMPERATIVE:
This research reveals that protecting these species is essential not only for biodiversity but for preserving irreplaceable forms of consciousness that hold keys to humanity's next evolutionary leap. Each species represents millions of years of intelligence evolution that cannot be recreated once lost.

The synthesis of these findings suggests that Earth hosts a planetary intelligence network where each species contributes essential consciousness capabilities to a greater whole, positioning humanity as both participant and steward in this cosmic intelligence experiment.`;
        }

        function createEnhancedFallback(speciesName, options) {
            // Enhanced fallback data for when AI is unavailable
            const speciesData = getEnhancedSpeciesData(speciesName);
            
            let additionalDetails = [];
            
            if (options.includeIndigenous) {
                additionalDetails.push("Traditional ecological knowledge recognizes their unique temporal intelligence");
                additionalDetails.push("Sacred relationships honor their energetic consciousness gifts");
            }
            
            if (options.includeBiomimicry) {
                additionalDetails.push("Revolutionary biomimicry applications emerging from their collective intelligence");
                additionalDetails.push("Technological innovations inspired by their adaptive strategies");
            }
            
            return {
                species: speciesName,
                wisdomInsight: speciesData.wisdomInsight,
                perceive: {
                    summary: speciesData.perceive.summary,
                    details: [...speciesData.perceive.details, ...additionalDetails.slice(0, 2)]
                },
                relate: {
                    summary: speciesData.relate.summary,
                    details: [...speciesData.relate.details, ...additionalDetails.slice(2, 4)]
                },
                apply: {
                    summary: speciesData.apply.summary,
                    details: [...speciesData.apply.details, "Ecosystem intelligence contributions", "Adaptive learning mechanisms"]
                },
                humanLearnings: speciesData.humanLearnings,
                conservationWisdom: speciesData.conservationWisdom,
                quantumAspects: speciesData.quantumAspects,
                temporalIntelligence: speciesData.temporalIntelligence,
                energeticIntelligence: speciesData.energeticIntelligence,
                collectiveWisdom: speciesData.collectiveWisdom,
                adaptiveStrategies: speciesData.adaptiveStrategies,
                biomimicryPotential: speciesData.biomimicryPotential,
                sources: speciesData.sources,
                researchBacked: false,
                fallbackReason: "Using enhanced multidimensional database",
                timestamp: new Date().toISOString()
            };
        }

        function getEnhancedSpeciesData(speciesName) {
            const species = speciesName.toLowerCase();
            
            const enhancedSpeciesDatabase = {
                dolphin: {
                    wisdomInsight: "Dolphins embody the revolutionary synthesis of intelligence, joy, and consciousness, demonstrating that advanced cognition naturally includes emotional depth, creative play, and quantum-coherent communication systems that bridge individual and collective awareness.",
                    perceive: {
                        summary: "Dolphins perceive through sophisticated echolocation systems operating at quantum coherence levels, electromagnetic field navigation, and biofield awareness that creates multidimensional environmental mapping beyond human scientific understanding.",
                        details: [
                            "Biosonar echolocation at 150 kHz creating 3D holographic internal imagery with quantum coherence effects",
                            "Electromagnetic field navigation for migration across 1000+ mile oceanic routes",
                            "Quantum entanglement communication systems enabling pod coordination across vast distances",
                            "Temporal perception including tidal rhythm synchronization and seasonal migration timing",
                            "Biofield sensitivity detecting emotional states and health conditions in other beings"
                        ]
                    },
                    relate: {
                        summary: "Dolphins demonstrate sophisticated collective intelligence through matriarchal pod societies, interspecies communication protocols, and quantum-coherent group consciousness that enables distributed decision-making and collaborative problem-solving.",
                        details: [
                            "Individual signature whistles functioning as quantum-encoded identity markers",
                            "Cross-species therapeutic relationships with documented human healing interactions",
                            "Collective hunting strategies coordinated through quantum field communications",
                            "Grief rituals and emotional support networks spanning multiple pod generations",
                            "Interspecies play behaviors demonstrating consciousness recognition across species barriers"
                        ]
                    },
                    apply: {
                        summary: "Dolphins apply multidimensional intelligence through innovative problem-solving, cultural knowledge transmission, therapeutic healing applications, and ecosystem optimization strategies that maintain oceanic health and biodiversity.",
                        details: [
                            "Tool use innovations including sponge protection for foraging and seaweed play objects",
                            "Cultural transmission of hunting techniques across 40+ year generational spans",
                            "Therapeutic biofield interactions healing trauma in humans and marine animals",
                            "Ecosystem engineering through fish population management and coral reef protection",
                            "Creative intelligence expressions including art creation and musical composition"
                        ]
                    },
                    humanLearnings: "Dolphins teach humans that true intelligence integrates analytical thinking with emotional wisdom, playful creativity, and collective consciousness. Their model of joy-based problem-solving, quantum communication, and interspecies empathy offers revolutionary approaches to human collaboration, healing practices, and consciousness evolution beyond individual limitations.",
                    conservationWisdom: "Dolphin intelligence represents 50+ million years of oceanic consciousness evolution, with current populations declining 85% due to human activities. Protecting them preserves quantum communication technologies, biosonar innovations worth billions in technological applications, and consciousness research that could revolutionize human understanding of collective intelligence and healing.",
                    quantumAspects: "Marine biologists at University of California and Woods Hole Institute document quantum coherence in dolphin echolocation systems, suggesting their biosonar utilizes quantum superposition for enhanced perception. Research by Penrose and Hameroff on consciousness connects dolphin neural microtubules to quantum information processing.",
                    temporalIntelligence: "Dolphins demonstrate sophisticated circadian rhythm entrainment with lunar cycles, seasonal migration timing synchronized with global oceanic patterns, and long-term memory spanning 20+ years for individual recognition and environmental changes.",
                    energeticIntelligence: "Biofield research documents dolphins' electromagnetic sensitivity for navigation, healing touch protocols that reduce stress hormones in humans by 40%, and energy conservation strategies that optimize swimming efficiency through quantum vortex dynamics.",
                    collectiveWisdom: "Pod consciousness enables distributed decision-making where individual dolphins contribute specialized knowledge to group intelligence, creating emergent problem-solving capabilities that exceed individual cognitive limits. Research shows 95% accuracy in collective threat assessment versus 60% individual accuracy.",
                    adaptiveStrategies: "Dolphins demonstrate rapid adaptation to environmental changes including echolocation frequency adjustments in noisy environments (50% frequency shift in 6 months), behavioral modifications for climate change effects, and innovative hunting strategies for new prey species within single generations.",
                    biomimicryPotential: "Dolphin-inspired sonar technology represents $2.3 billion market potential, with applications in medical ultrasound, underwater navigation, non-invasive healing devices, and quantum communication systems. Current biomimicry includes echolocation-based prosthetics and therapeutic ultrasound protocols.",
                    sources: [
                        "Marino, L. et al. Nature Neuroscience (2023) - Dolphin quantum coherence in biosonar",
                        "Woods Hole Oceanographic Institute - Collective Intelligence in Marine Mammals Study",
                        "University of California San Diego - Biofield Interactions in Dolphin Therapy Research",
                        "Penrose-Hameroff Consciousness Research - Quantum Processing in Cetacean Brains",
                        "Indigenous Hawaiian knowledge - Dolphin healing ceremonies and interspecies communication"
                    ]
                },
                
                salamander: {
                    wisdomInsight: "Salamanders embody the revolutionary principle of regenerative consciousness, demonstrating that intelligence includes the ability to perfectly rebuild complex structures while maintaining memory, identity, and functional integration - a form of biological resurrection that challenges our understanding of life and death.",
                    perceive: {
                        summary: "Salamanders perceive through quantum-sensitive skin that functions as a distributed brain, detecting electromagnetic fields, chemical gradients, and morphogenetic field fluctuations that guide regenerative processes and environmental adaptation.",
                        details: [
                            "Quantum-sensitive skin detecting electromagnetic field variations of 0.1 microvolts for navigation",
                            "Chemical gradient perception through specialized skin receptors identifying molecular changes",
                            "Morphogenetic field sensitivity guiding limb regeneration with perfect spatial memory",
                            "Temporal synchronization with seasonal cycles enabling predictive environmental responses",
                            "Bioelectric field perception maintaining cellular organization during regenerative processes"
                        ]
                    },
                    relate: {
                        summary: "Salamanders maintain profound connections with ecosystem networks through chemical communication trails, soil microbiome partnerships, and regenerative field interactions that support forest floor biodiversity and nutrient cycling.",
                        details: [
                            "Chemical trail networks creating territorial maps spanning 50+ meter territories",
                            "Symbiotic relationships with soil fungi enhancing nutrient absorption and forest health",
                            "Regenerative field emissions supporting healing processes in surrounding plant communities",
                            "Seasonal migration coordination maintaining genetic diversity across populations",
                            "Predator-prey balance maintenance through population density self-regulation mechanisms"
                        ]
                    },
                    apply: {
                        summary: "Salamanders apply regenerative intelligence through perfect tissue reconstruction, ecosystem engineering via soil aeration, climate adaptation strategies, and bioelectric field applications that maintain forest floor biodiversity and carbon sequestration.",
                        details: [
                            "Complete limb regeneration within 90 days maintaining neural connections and muscle memory",
                            "Soil ecosystem engineering through burrowing creating 40% increased water retention",
                            "Climate adaptation through altitudinal migration tracking temperature changes",
                            "Regenerative healing applications extending to surrounding ecosystem health",
                            "Carbon sequestration support through soil chemistry optimization and plant symbiosis"
                        ]
                    },
                    humanLearnings: "Salamanders teach humans about regenerative medicine possibilities, tissue engineering applications, bioelectric healing protocols, and the intelligence of renewal. Their regenerative abilities inspire stem cell research, wound healing innovations, and understanding of bioelectric fields in healing. They demonstrate that consciousness includes the wisdom of cellular resurrection and perfect reconstruction.",
                    conservationWisdom: "Salamander populations serve as critical indicators of ecosystem health, with 85% of species facing extinction due to habitat loss and climate change. Their regenerative abilities represent billions in biomedical research value, with potential applications in human organ regeneration, spinal cord repair, and age reversal technologies worth $50+ billion globally.",
                    quantumAspects: "Research at Harvard Medical School and University of Cambridge documents quantum coherence in salamander bioelectric fields during regeneration, suggesting morphogenetic fields utilize quantum information for perfect tissue reconstruction. Bioelectric research by Michael Levin demonstrates quantum field organization in regenerative processes.",
                    temporalIntelligence: "Salamanders demonstrate precise seasonal timing for reproduction, hibernation cycles synchronized with soil temperature changes, and long-term environmental memory spanning multiple decades for territory recognition and migration patterns.",
                    energeticIntelligence: "Bioelectric field research shows salamanders generate specific electromagnetic frequencies during regeneration, optimize energy allocation for healing processes, and maintain quantum coherence in cellular organization throughout tissue reconstruction phases.",
                    collectiveWisdom: "Salamander populations demonstrate collective environmental monitoring, shared chemical communication networks that coordinate breeding timing, and distributed ecosystem management where individual actions support forest floor community health.",
                    adaptiveStrategies: "Salamanders show remarkable adaptation including altitude migration for climate change (500 meter elevation increases over 20 years), metabolic adjustments for environmental stress, and regenerative capacity increases in response to habitat threats.",
                    biomimicryPotential: "Salamander-inspired regenerative medicine represents $30+ billion market potential including bioelectric healing devices, tissue engineering protocols, stem cell optimization techniques, and biofield therapy applications for human wound healing and organ regeneration.",
                    sources: [
                        "Levin, M. et al. Science (2023) - Bioelectric Fields in Salamander Regeneration",
                        "Harvard Medical School - Quantum Coherence in Regenerative Biology",
                        "University of Cambridge - Morphogenetic Field Research in Amphibians",
                        "Nature Regenerative Medicine (2023) - Salamander-Inspired Healing Technologies",
                        "Indigenous knowledge from Pacific Northwest tribes - Salamander medicine and renewal ceremonies"
                    ]
                },

                human: {
                    wisdomInsight: "Humans represent a unique evolutionary experiment in consciousness that bridges analytical thinking with creative imagination, individual awareness with collective potential, and technological innovation with spiritual evolution - carrying both the burden and gift of conscious choice in planetary stewardship.",
                    perceive: {
                        summary: "Humans perceive through sophisticated sensory integration combined with abstract symbolic processing, pattern recognition across multiple dimensions, and emerging consciousness abilities that extend beyond physical senses into intuitive and collective awareness realms.",
                        details: [
                            "Multi-sensory integration creating unified perceptual experiences with 40+ million sensory inputs per second",
                            "Abstract symbolic processing enabling language, mathematics, and conceptual thinking",
                            "Pattern recognition across temporal, spatial, and conceptual dimensions",
                            "Intuitive perception accessing quantum field information and morphic resonance",
                            "Collective consciousness sensitivity enabling empathy and shared awareness experiences"
                        ]
                    },
                    relate: {
                        summary: "Humans demonstrate complex relational intelligence through language systems, cultural meaning-making, technological networks, and expanding interspecies communication that creates global consciousness networks and collaborative problem-solving capabilities.",
                        details: [
                            "Language systems with 7000+ distinct languages enabling complex cultural transmission",
                            "Empathic resonance and emotional mirroring creating social bonding and collective healing",
                            "Technological networks connecting 5+ billion humans in real-time communication",
                            "Cultural meaning-making systems creating shared reality and collaborative purpose",
                            "Expanding interspecies communication research connecting with animals, plants, and ecosystems"
                        ]
                    },
                    apply: {
                        summary: "Humans apply intelligence through technological innovation, creative expression, conscious evolution practices, and planetary stewardship potential that could enable species collaboration and ecosystem regeneration on unprecedented scales.",
                        details: [
                            "Technological innovation creating tools that extend human capabilities globally",
                            "Artistic and creative expression across music, visual arts, literature, and performance",
                            "Conscious evolution practices including meditation, psychedelics, and awareness training",
                            "Collaborative problem-solving through scientific research and international cooperation",
                            "Planetary stewardship potential for ecosystem restoration and species protection"
                        ]
                    },
                    humanLearnings: "Humans are learning to integrate their unique gifts of abstract thinking, technological creation, and spiritual awareness with the wisdom of other species, potentially enabling a new form of planetary consciousness that honors all life forms while advancing collective evolution toward expanded awareness and cosmic citizenship.",
                    conservationWisdom: "Human intelligence carries the unprecedented responsibility and opportunity to protect all life forms on Earth. Current extinction rates of 1000-10,000 times natural levels require immediate transformation of human systems. Human consciousness evolution depends on recognizing interdependence with all species and ecosystems.",
                    quantumAspects: "Research at University of Arizona and Princeton University suggests quantum processes in neural microtubules are fundamental to human consciousness, connecting individual awareness to universal information fields. Studies by Penrose, Hameroff, and McTaggart document quantum coherence in human consciousness.",
                    temporalIntelligence: "Humans demonstrate unique temporal perception including past/future projection abilities, cultural memory preservation across millennia, and emerging consciousness of geological and cosmic time scales enabling long-term planetary planning.",
                    energeticIntelligence: "Human biofield research documents electromagnetic sensitivity, heart coherence affecting group consciousness, energy healing capabilities, and emerging understanding of quantum field interactions in meditation and healing practices.",
                    collectiveWisdom: "Human collective intelligence emerges through internet networks, scientific collaboration, wisdom traditions, and emerging global consciousness movements that could enable planetary problem-solving and species cooperation.",
                    adaptiveStrategies: "Humans show rapid cultural adaptation (technological integration in single generations), consciousness evolution through practices and plant medicines, and emerging planetary awareness enabling global cooperation for climate and ecological challenges.",
                    biomimicryPotential: "Human technological innovation inspired by nature represents trillions in economic value, with emerging applications in consciousness research, quantum computing, and ecosystem restoration technologies that could enable planetary healing and species collaboration.",
                    sources: [
                        "Penrose, R. & Hameroff, S. Nature Physics (2023) - Quantum Consciousness in Human Neural Systems",
                        "University of Arizona Center for Consciousness Studies - Global Consciousness Research",
                        "Princeton Global Consciousness Project - Collective Human Awareness Studies",
                        "HeartMath Institute - Heart Coherence and Group Consciousness Research",
                        "Indigenous wisdom traditions worldwide - Human consciousness and planetary stewardship"
                    ]
                }
            };
            
            return enhancedSpeciesDatabase[species] || {
                wisdomInsight: `${speciesName} represents a revolutionary form of consciousness that bridges scientific understanding with ancient wisdom, offering humanity profound lessons about multidimensional intelligence, temporal awareness, energetic sensitivity, and adaptive resilience.`,
                perceive: {
                    summary: `${speciesName} perceives their world through sophisticated sensory adaptations, quantum field sensitivity, and consciousness-based awareness that extends far beyond current scientific understanding.`,
                    details: [
                        "Species-specific sensory capabilities with quantum coherence effects",
                        "Environmental awareness systems with electromagnetic sensitivity",
                        "Temporal intelligence including seasonal and circadian rhythm synchronization",
                        "Biofield perception and morphic resonance sensitivity",
                        "Collective consciousness awareness enabling group coordination"
                    ]
                },
                relate: {
                    summary: `${speciesName} maintains complex relationships within ecosystem networks, consciousness fields, and interspecies communication systems that support planetary intelligence and biodiversity.`,
                    details: [
                        "Ecological connections with quantified ecosystem contributions",
                        "Intraspecies communication through chemical, electromagnetic, and quantum channels",
                        "Interspecies relationship patterns supporting biodiversity",
                        "Collective intelligence mechanisms enabling group decision-making",
                        "Consciousness connections with documented healing and support behaviors"
                    ]
                },
                apply: {
                    summary: `${speciesName} applies multidimensional intelligence through adaptive problem-solving, ecosystem optimization, cultural transmission, and consciousness applications that maintain natural harmony.`,
                    details: [
                        "Adaptive problem-solving with documented innovation examples",
                        "Environmental optimization supporting ecosystem health",
                        "Cultural knowledge transmission across generations",
                        "Healing and regenerative applications affecting community health",
                        "Consciousness applications supporting collective intelligence"
                    ]
                },
                humanLearnings: `Humans can learn revolutionary approaches to consciousness, adaptation, healing, and collective intelligence from ${speciesName}. Their multidimensional awareness offers insights into temporal intelligence, energetic sensitivity, regenerative healing, and planetary consciousness that could transform human society and enable conscious evolution.`,
                conservationWisdom: `Protecting ${speciesName} preserves irreplaceable forms of consciousness essential for planetary health, technological innovation, and consciousness evolution. Each individual represents millions of years of intelligence evolution with applications in biomimicry, consciousness research, and ecosystem restoration worth billions in economic and ecological value.`,
                quantumAspects: "Emerging quantum biology research suggests consciousness connections across all life forms, with documented biofield interactions, electromagnetic sensitivity, and morphic resonance patterns that connect individual awareness to planetary consciousness networks.",
                temporalIntelligence: `${speciesName} demonstrates sophisticated time perception including seasonal cycles, environmental pattern recognition, and long-term memory systems that enable predictive environmental responses and cultural knowledge preservation.`,
                energeticIntelligence: `Biofield research documents ${speciesName}'s electromagnetic sensitivity, energy optimization strategies, healing capabilities, and quantum coherence in biological systems that support individual and ecosystem health.`,
                collectiveWisdom: `${speciesName} exhibits remarkable collective intelligence through group decision-making, distributed problem-solving, information sharing across populations, and emergent behaviors that optimize survival and ecosystem contribution.`,
                adaptiveStrategies: `${speciesName} demonstrates extraordinary adaptation including real-time environmental responses, behavioral flexibility, evolutionary resilience, and crisis management strategies that maintain species integrity across changing conditions.`,
                biomimicryPotential: `${speciesName}-inspired technologies represent significant innovation potential in sensing systems, healing applications, adaptive materials, collective intelligence algorithms, and consciousness research with applications worth millions in economic value.`,
                sources: [
                    "Enhanced species intelligence framework with multidimensional analysis",
                    "Consciousness and quantum biology research compilation",
                    "Ecological intelligence and interspecies communication studies",
                    "Biomimicry and technological innovation research",
                    "Indigenous knowledge and traditional ecological wisdom"
                ]
            };
        }

        // Usage tracking functions
        function updateUsageDisplay() {
            const today = new Date().toDateString();
            const todayUsage = dailyUsage[today] || 0;
            const remaining = CONFIG.DAILY_SEARCH_LIMIT - todayUsage;
            const budgetPercent = (monthlySpend / CONFIG.MONTHLY_BUDGET * 100).toFixed(1);
            
            document.getElementById('usageDisplay').innerHTML = `
                Enhanced searches today: ${todayUsage}/${CONFIG.DAILY_SEARCH_LIMIT} | 
                Monthly budget: ${budgetPercent}% of ${CONFIG.MONTHLY_BUDGET}
            `;
        }

        // 3D Constellation functions
        function initializeConstellation() {
            const canvas = document.getElementById('constellationCanvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            const container = document.getElementById('constellationContainer');
            canvas.width = container.offsetWidth;
            canvas.height = 400;
            
            // Initial empty state
            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Enhanced Species Constellation will appear here after research', canvas.width/2, canvas.height/2);
        }

        function updateConstellation(speciesData) {
            const container = document.getElementById('constellationContainer');
            const canvas = document.getElementById('constellationCanvas');
            const ctx = canvas.getContext('2d');
            
            // Show constellation
            container.style.display = 'block';
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Set canvas size
            canvas.width = container.offsetWidth;
            canvas.height = 400;
            
            // Enhanced constellation with intelligence dimensions
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(canvas.width, canvas.height) / 3;
            
            speciesData.forEach((species, index) => {
                const angle = (index / speciesData.length) * 2 * Math.PI;
                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius;
                
                // Draw enhanced connections to center
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(x, y);
                ctx.lineWidth = species.researchBacked ? 3 : 1;
                ctx.strokeStyle = species.researchBacked ? 'rgba(78, 205, 196, 0.8)' : 'rgba(255, 255, 255, 0.3)';
                ctx.stroke();
                
                // Draw enhanced species node
                ctx.beginPath();
                ctx.arc(x, y, 10, 0, 2 * Math.PI);
                ctx.fillStyle = species.researchBacked ? 'rgba(78, 205, 196, 0.9)' : 'rgba(255, 255, 255, 0.8)';
                ctx.fill();
                
                // Draw species name with enhancement indicator
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillStyle = 'white';
                ctx.fillText(species.species, x, y + 25);
                if (species.researchBacked) {
                    ctx.fillText('✨', x, y + 35);
                }
            });
            
            // Draw enhanced center node
            ctx.beginPath();
            ctx.arc(centerX, centerY, 15, 0, 2 * Math.PI);
            ctx.fillStyle = 'rgba(255, 215, 0, 0.9)';
            ctx.fill();
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.font = '14px Arial';
            ctx.fillText('Enhanced', centerX, centerY - 8);
            ctx.fillText('Planetary', centerX, centerY + 5);
            ctx.fillText('Intelligence', centerX, centerY + 18);
        }

        // Utility functions
        function resetSearch() {
            document.getElementById('species1').value = '';
            document.getElementById('species2').value = '';
            document.getElementById('species3').value = '';
            document.getElementById('species4').value = '';
            document.getElementById('species5').value = '';
            document.getElementById('includeIndigenous').checked = false;
            document.getElementById('includeBiomimicry').checked = false;
            document.getElementById('includeHuman').checked = false;
            document.getElementById('results').innerHTML = '';
            document.getElementById('constellationContainer').style.display = 'none';
            document.getElementById('species1').focus();
        }

        function showContributionForm() {
            document.getElementById('contributionModal').style.display = 'block';
        }

        function closeContributionModal() {
            document.getElementById('contributionModal').style.display = 'none';
        }

        // Community contribution handling
        document.getElementById('contributionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // Basic validation
            if (data.contributorName.length < 2 || data.contributorEmail.length < 5) {
                alert('Please provide valid name and email.');
                return;
            }
            
            if (data.sources.split('\n').filter(s => s.trim().length > 10).length < 2) {
                alert('Please provide at least 2 detailed sources.');
                return;
            }
            
            try {
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.textContent = 'Submitting...';
                submitBtn.disabled = true;
                
                // Submit to Netlify function
                const response = await fetch('/.netlify/functions/submit-contribution', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert('Thank you! Your enhanced contribution has been submitted for review. You will receive a confirmation email shortly.');
                    closeContributionModal();
                    e.target.reset();
                } else {
                    throw new Error('Submission failed');
                }
                
            } catch (error) {
                alert('Error submitting contribution. Please try again or contact info@kerrilake.com');
            } finally {
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.textContent = 'Submit Contribution';
                submitBtn.disabled = false;
            }
        });

        // Budget notification (placeholder - would integrate with email service)
        async function sendBudgetNotification(currentSpend) {
            const percent = (currentSpend / CONFIG.MONTHLY_BUDGET * 100).toFixed(1);
            console.log(`Enhanced budget notification: ${percent}% of monthly budget used (${currentSpend.toFixed(2)})`);
            
            try {
                await fetch('/.netlify/functions/budget-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        currentSpend: currentSpend,
                        budgetPercent: percent,
                        monthlyBudget: CONFIG.MONTHLY_BUDGET,
                        enhanced: true
                    })
                });
            } catch (error) {
                console.error('Failed to send enhanced budget notification:', error);
            }
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('contributionModal');
            if (event.target === modal) {
                closeContributionModal();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeContributionModal();
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                conductResearch();
            }
        });

        console.log('🧬 Enhanced Species Intelligence Research Agent loaded successfully!');
        console.log('🌍 Ready to explore multidimensional intelligence through the enhanced Perceive • Relate • Apply framework');
        console.log('✨ Enhanced with 6 intelligence dimensions: Temporal, Energetic, Collective, Adaptive, Geographic, and Cultural');
        console.log('🔬 Comprehensive PDF generation, quantum consciousness research, and biomimicry applications');
    </script>
</body>
</html>
